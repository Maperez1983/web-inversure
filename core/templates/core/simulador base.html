{#
=================================================
SIMULADOR BASE ‚Äì PLANTILLA CONGELADA
NO MODIFICAR
Fecha: 2025-12-25
Motivo: Backup estable antes de l√≥gicas avanzadas
=================================================
#}
{% extends "core/base.html" %}
{% load static %}
{% block content %}

<div class="container mt-4" data-fase="{{ fase }}">
    <h1 class="mb-1">Simulador de operaciones</h1>
    <p class="text-muted mb-4">
        Introduce los datos para calcular rentabilidad y m√©tricas clave.
    </p>


<form method="post" {% if not editable %}class="form-readonly"{% endif %}>
{% csrf_token %}



    <!-- ===============================
         DATOS DEL INMUEBLE
    ================================ -->
    <div class="card mb-4 shadow-sm border-0" data-fase="estudio">
        <div class="card-body">
            <h5 class="mb-3 d-flex align-items-center gap-2">
                <span>üìç</span>
                <span>Datos del inmueble</span>
            </h5>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label text-muted">
                        Nombre del proyecto (identificador)
                    </label>
                    <input type="text" name="nombre" class="form-control form-control-lg"
                           value="{{ proyecto.nombre|default:'' }}" {% if not editable %}disabled{% endif %}>
                </div>

                <div class="col-md-6 mb-3">
                    <label class="form-label text-muted">
                        Estado del proyecto
                    </label>
                    <select name="estado" class="form-select form-select-lg" {% if not editable %}disabled{% endif %}>
                        <option value="estudio"
                            {% if proyecto.estado == "estudio" or not proyecto.estado %}selected{% endif %}>
                            En estudio
                        </option>

                        <option value="operacion"
                            {% if proyecto.estado == "operacion" %}selected{% endif %}>
                            En operaci√≥n
                        </option>

                        <option value="cerrado_positivo"
                            {% if proyecto.estado == "cerrado_positivo" %}selected{% endif %}>
                            Cerrado positivamente
                        </option>

                        <option value="descartado"
                            {% if proyecto.estado == "descartado" %}selected{% endif %}>
                            Descartado
                        </option>
                    </select>
                </div>

                <div class="col-md-6 mb-3">
                    <label class="form-label">Fecha</label>
                    <input type="date" name="fecha" class="form-control form-control-lg"
                           value="{{ proyecto.fecha|date:'Y-m-d'|default:'' }}" {% if not editable %}disabled{% endif %}>
                </div>
            </div>



            <div class="row">
                <div class="col-md-6 mb-3 d-flex gap-2">
                    <div class="flex-grow-1">
                        <label class="form-label">Referencia catastral</label>
                        <input type="text" name="ref_catastral" class="form-control form-control-lg" {% if not editable %}disabled{% endif %}>
                    </div>
                    <div class="align-self-end">
                        <button type="button"
                                id="btnCatastro"
                                class="btn btn-sm px-2 d-flex align-items-center"
                                style="background-color:#122135; color:white;"
                                onclick="verCatastro()"
                                title="Abrir Catastro">
                            <img src="{% static 'core/catastro.png' %}"
                                 alt="Catastro"
                                 style="height:18px; width:auto; filter:brightness(0) invert(1);">
                        </button>
                    </div>
                </div>

                <div class="col-md-6 mb-3">
                    <label class="form-label">Valor de referencia catastral</label>
                    <input type="text" name="valor_referencia" class="form-control" data-euro="true"
                           value="{{ proyecto.valor_referencia|default:'' }}" {% if not editable %}disabled{% endif %}>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">
                        Valor de adquisici√≥n
                        <span class="ms-1 text-muted" title="Calculado autom√°ticamente">‚ÑπÔ∏è</span>
                    </label>
                    <input type="text" name="precio_compra_inmueble"
                           class="form-control form-control-lg"
                           data-euro="true"
                           readonly
                           value="{{ proyecto.precio_compra_inmueble|default:'' }}" {% if not editable %}disabled{% endif %}>
                </div>

                <div class="col-md-6 mb-3">
                    <label class="form-label">Valor de transmisi√≥n</label>
                    <input type="text" name="precio_venta_estimado"
                           class="form-control form-control-lg"
                           data-euro="true"
                           value="{{ proyecto.precio_venta_estimado|default:'' }}" {% if not editable %}disabled{% endif %}>
                </div>
            </div>
        </div>
    </div>

    <!-- ===============================
         DATOS PRINCIPALES
    ================================ -->
    <div class="card mb-4 shadow-sm border-0" data-fase="operacion">
        <div class="card-body">
            <h5 class="mb-3">
                <span class="badge rounded-pill bg-secondary me-2 px-3 py-2">1</span>
                Datos principales
            </h5>

            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label">Precio de escritura</label>
                    <input type="text" name="precio_propiedad"
                           class="form-control form-control-lg"
                           data-euro="true"
                           value="{{ proyecto.precio_propiedad|default:'' }}" {% if not editable %}disabled{% endif %}>
                </div>

                <div class="col-md-4 mb-3">
                    <label class="form-label">Venta estimada</label>
                    <input type="text" name="venta_estimada"
                           class="form-control form-control-lg"
                           data-euro="true"
                           value="{{ proyecto.venta_estimada|default:'' }}" {% if not editable %}disabled{% endif %}>
                </div>

                <div class="col-md-4 mb-3">
                    <label class="form-label">Tiempo estimado de operaci√≥n (meses)</label>
                    <input type="text" name="meses"
                           class="form-control"
                           data-number="true"
                           value="{{ proyecto.meses|default:'' }}" {% if not editable %}disabled{% endif %}>
                </div>
            </div>

            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label">% Financiaci√≥n</label>
                    <input type="text" name="financiacion_pct"
                           class="form-control"
                           data-number="true"
                           value="{{ proyecto.financiacion_pct|default:'' }}" {% if not editable %}disabled{% endif %}>
                </div>
            </div>
        </div>
    </div>

    <!-- ===============================
         GASTOS DE ADQUISICI√ìN
    ================================ -->
    <div class="card mb-4 shadow-sm border-0" data-fase="operacion">
        <div class="card-body">
            <h5 class="mb-3">
                <span class="badge rounded-pill bg-secondary me-2 px-3 py-2">2</span>
                Gastos de adquisici√≥n
            </h5>

            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label">
                      Notar√≠a
                      <span class="ms-1 text-muted" title="Calculado autom√°ticamente en base a los datos introducidos">‚ÑπÔ∏è</span>
                    </label>
                    <input type="text" name="notaria" class="form-control form-control-lg" data-euro="true"
                           value="{{ proyecto.notaria|default:'' }}" {% if not editable %}disabled{% endif %}>
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">
                      Registro
                      <span class="ms-1 text-muted" title="Calculado autom√°ticamente en base a los datos introducidos">‚ÑπÔ∏è</span>
                    </label>
                    <input type="text" name="registro" class="form-control form-control-lg" data-euro="true"
                           value="{{ proyecto.registro|default:'' }}" {% if not editable %}disabled{% endif %}>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">
                      ITP
                      <span class="ms-1 text-muted" title="Calculado autom√°ticamente en base a los datos introducidos">‚ÑπÔ∏è</span>
                    </label>
                    <input type="text" name="itp" class="form-control form-control-lg" data-euro="true"
                           value="{{ proyecto.itp|default:'' }}" {% if not editable %}disabled{% endif %}>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Otros gastos</label>
                    <input type="text" name="otros_gastos_compra" class="form-control" data-euro="true"
                           value="{{ proyecto.otros_gastos_compra|default:'' }}" {% if not editable %}disabled{% endif %}>
                </div>
            </div>
        </div>
    </div>

    <!-- ===============================
         INVERSI√ìN INICIAL
    ================================ -->
    <div class="card mb-4 shadow-sm border-0" data-fase="operacion">
        <div class="card-body">
            <h5 class="mb-3">
                <span class="badge rounded-pill bg-secondary me-2 px-3 py-2">4</span>
                Inversi√≥n inicial
            </h5>

            <div class="row">
                <div class="col-md-3 mb-3">
                    <label class="form-label">Reforma</label>
                    <input type="text" name="reforma" class="form-control form-control-lg" data-euro="true"
                           value="{{ proyecto.reforma|default:'' }}" {% if not editable %}disabled{% endif %}>
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Limpieza inicial</label>
                    <input type="text" name="limpieza_inicial" class="form-control form-control-lg" data-euro="true"
                           value="{{ proyecto.limpieza_inicial|default:'' }}" {% if not editable %}disabled{% endif %}>
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Mobiliario</label>
                    <input type="text" name="mobiliario" class="form-control form-control-lg" data-euro="true"
                           value="{{ proyecto.mobiliario|default:'' }}" {% if not editable %}disabled{% endif %}>
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Otros puesta en marcha</label>
                    <input type="text" name="otros_puesta_marcha" class="form-control form-control-lg" data-euro="true"
                           value="{{ proyecto.otros_puesta_marcha|default:'' }}" {% if not editable %}disabled{% endif %}>
                </div>
            </div>
        </div>
    </div>


    <!-- ===============================
         OBRA (DETALLE POR PARTIDAS)
    ================================ -->
    <div class="card mb-4 shadow-sm border-0" data-fase="operacion">
        <div class="card-body">
            <h5 class="mb-3">
                <span class="badge rounded-pill bg-secondary me-2 px-3 py-2">4A</span>
                Obra (detalle por partidas)
            </h5>

            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label">Demoliciones / desescombro</label>
                    <input type="text" name="obra_demoliciones" class="form-control" data-euro="true"
                        value="{{ proyecto.obra_demoliciones|default:'' }}">
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Alba√±iler√≠a</label>
                    <input type="text" name="obra_albanileria" class="form-control" data-euro="true"
                        value="{{ proyecto.obra_albanileria|default:'' }}">
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Fontaner√≠a</label>
                    <input type="text" name="obra_fontaneria" class="form-control" data-euro="true"
                        value="{{ proyecto.obra_fontaneria|default:'' }}">
                </div>
            </div>

            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label">Electricidad</label>
                    <input type="text" name="obra_electricidad" class="form-control" data-euro="true"
                        value="{{ proyecto.obra_electricidad|default:'' }}">
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Carpinter√≠a interior</label>
                    <input type="text" name="obra_carpinteria_interior" class="form-control" data-euro="true"
                        value="{{ proyecto.obra_carpinteria_interior|default:'' }}">
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Carpinter√≠a exterior</label>
                    <input type="text" name="obra_carpinteria_exterior" class="form-control" data-euro="true"
                        value="{{ proyecto.obra_carpinteria_exterior|default:'' }}">
                </div>
            </div>

            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label">Cocina</label>
                    <input type="text" name="obra_cocina" class="form-control" data-euro="true"
                        value="{{ proyecto.obra_cocina|default:'' }}">
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Ba√±os</label>
                    <input type="text" name="obra_banos" class="form-control" data-euro="true"
                        value="{{ proyecto.obra_banos|default:'' }}">
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Pintura</label>
                    <input type="text" name="obra_pintura" class="form-control" data-euro="true"
                        value="{{ proyecto.obra_pintura|default:'' }}">
                </div>
            </div>

            <div class="row">
                <div class="col-md-12 mb-3">
                    <label class="form-label">Otros trabajos de obra</label>
                    <input type="text" name="obra_otros" class="form-control" data-euro="true"
                        value="{{ proyecto.obra_otros|default:'' }}">
                </div>
            </div>
        </div>
    </div>

    <!-- ===============================
         SEGURIDAD Y CONTROL
    ================================ -->
    <div class="card mb-4 shadow-sm border-0" data-fase="operacion">
        <div class="card-body">
            <h5 class="mb-3">
                <span class="badge rounded-pill bg-secondary me-2 px-3 py-2">4B</span>
                Seguridad y control
            </h5>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Cerrajero</label>
                    <input type="text" name="seguridad_cerrajero" class="form-control" data-euro="true"
                        value="{{ proyecto.cerrajero|default:'' }}">
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Alarma</label>
                    <input type="text" name="seguridad_alarma" class="form-control" data-euro="true"
                        value="{{ proyecto.alarma|default:'' }}">
                </div>
            </div>
        </div>
    </div>

    <!-- ===============================
         GASTOS RECURRENTES
    ================================ -->
    <div class="card mb-4 shadow-sm border-0" data-fase="operacion">
        <div class="card-body">
            <h5 class="mb-3">
                <span class="badge rounded-pill bg-secondary me-2 px-3 py-2">5</span>
                Gastos recurrentes
            </h5>

            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label">Comunidad</label>
                    <input type="text" name="comunidad" class="form-control" data-euro="true"
                           value="{{ proyecto.comunidad|default:'' }}" {% if not editable %}disabled{% endif %}>
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">IBI</label>
                    <input type="text" name="ibi" class="form-control" data-euro="true"
                           value="{{ proyecto.ibi|default:'' }}" {% if not editable %}disabled{% endif %}>
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Seguros</label>
                    <input type="text" name="seguros" class="form-control" data-euro="true"
                           value="{{ proyecto.seguros|default:'' }}" {% if not editable %}disabled{% endif %}>
                </div>
            </div>

            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label">Suministros</label>
                    <input type="text" name="suministros" class="form-control" data-euro="true"
                           value="{{ proyecto.suministros|default:'' }}" {% if not editable %}disabled{% endif %}>
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Limpieza peri√≥dica</label>
                    <input type="text" name="limpieza_periodica" class="form-control" data-euro="true"
                           value="{{ proyecto.limpieza_periodica|default:'' }}" {% if not editable %}disabled{% endif %}>
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Ocupas</label>
                    <input type="text" name="ocupas" class="form-control" data-euro="true"
                           value="{{ proyecto.ocupas|default:'' }}" {% if not editable %}disabled{% endif %}>
                </div>
            </div>
        </div>
    </div>

    <!-- ===============================
         GASTOS DE VENTA
    ================================ -->
    <div class="card mb-4 shadow-sm border-0" data-fase="operacion">
        <div class="card-body">
            <h5 class="mb-3">
                <span class="badge rounded-pill bg-secondary me-2 px-3 py-2">6</span>
                Gastos de venta
            </h5>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Plusval√≠a</label>
                    <input type="text" name="plusvalia" class="form-control" data-euro="true"
                           value="{{ proyecto.plusvalia|default:'' }}" {% if not editable %}disabled{% endif %}>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Inmobiliaria</label>
                    <input type="text" name="inmobiliaria" class="form-control" data-euro="true"
                           value="{{ proyecto.inmobiliaria|default:'' }}" {% if not editable %}disabled{% endif %}>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Gesti√≥n comercial</label>
                    <input type="text" name="gestion_comercial" class="form-control" data-euro="true"
                           value="{{ proyecto.gestion_comercial|default:'' }}" {% if not editable %}disabled{% endif %}>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Gesti√≥n administraci√≥n</label>
                    <input type="text" name="gestion_administracion" class="form-control" data-euro="true"
                           value="{{ proyecto.gestion_administracion|default:'' }}" {% if not editable %}disabled{% endif %}>
                </div>
            </div>
        </div>
    </div>

    <!-- ===============================
         VALORACIONES
    ================================ -->
    <div class="card mb-4 shadow-sm border-0" data-fase="operacion">
        <div class="card-body">
            <h5 class="mb-3">
                <span class="badge rounded-pill bg-secondary me-2 px-3 py-2">7</span>
                Valoraciones
            </h5>

            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label">Idealista</label>
                    <input type="text" name="val_idealista" class="form-control" data-euro="true" data-valuation="true"
                           value="{{ proyecto.val_idealista|default:'' }}" {% if not editable %}disabled{% endif %}>
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Fotocasa</label>
                    <input type="text" name="val_fotocasa" class="form-control" data-euro="true" data-valuation="true"
                           value="{{ proyecto.val_fotocasa|default:'' }}" {% if not editable %}disabled{% endif %}>
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Registradores</label>
                    <input type="text" name="val_registradores" class="form-control" data-euro="true" data-valuation="true"
                           value="{{ proyecto.val_registradores|default:'' }}" {% if not editable %}disabled{% endif %}>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Casafari</label>
                    <input type="text" name="val_casafari" class="form-control" data-euro="true" data-valuation="true"
                           value="{{ proyecto.val_casafari|default:'' }}" {% if not editable %}disabled{% endif %}>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Tasaci√≥n</label>
                    <input type="text" name="val_tasacion" class="form-control" data-euro="true" data-valuation="true"
                           value="{{ proyecto.val_tasacion|default:'' }}" {% if not editable %}disabled{% endif %}>
                </div>
            </div>

            <div class="row mt-3">
                <div class="col-md-12">
                    <label class="form-label fw-semibold">
                      Media de valoraciones
                      <span class="ms-1 text-muted" title="Calculado autom√°ticamente en base a los datos introducidos">‚ÑπÔ∏è</span>
                    </label>
                    <input type="text" name="media_valoraciones" class="form-control form-control-lg" readonly title="Calculado autom√°ticamente en base a los datos introducidos"
                           value="{{ proyecto.media_valoraciones|default:'' }}" {% if not editable %}disabled{% endif %}>
                </div>
            </div>
        </div>
    </div>

    <!-- ===============================
         ACCIONES
    ================================ -->
    {% if not editable %}
    <div class="alert alert-warning small">
        üîí Este proyecto est√° cerrado y se encuentra en modo solo lectura.
    </div>
    {% endif %}
    <div class="d-flex justify-content-between align-items-center mb-4">
        <button type="submit" class="btn btn-dark" {% if not editable %}disabled{% endif %}>
            Calcular
        </button>
    </div>

    <!-- ===============================
         RESULTADOS
    ================================ -->
{% if resultado %}
<div class="card mb-5 shadow-sm border-0 resultado-inversor
     {% if resultado.viable %}resultado-viable{% elif resultado.ajustada %}resultado-ajustada{% else %}resultado-no-viable{% endif %}">
    <div class="card-body">

        <!-- VEREDICTO -->
        <div class="mb-4">
            {% if resultado.viable %}
                <h3 class="text-success fw-bold">‚úî OPERACI√ìN VIABLE</h3>
                <p class="text-muted mb-0">
                    Cumple los criterios m√≠nimos exigidos por Inversure
                </p>
                <div class="mt-2 small text-muted">
                    <strong>Criterios aplicados:</strong>
                    ROI m√≠nimo ‚â• 15 % ¬∑ Beneficio m√≠nimo ‚â• 30.000 ‚Ç¨
                </div>
            {% elif resultado.ajustada %}
                <h3 class="text-warning fw-bold">‚ö† OPERACI√ìN AJUSTADA</h3>
                <p class="text-muted mb-0">
                    ROI correcto, pero beneficio inferior al objetivo
                </p>
                <div class="mt-2 small text-muted">
                    <strong>Criterios aplicados:</strong>
                    ROI m√≠nimo ‚â• 15 % ¬∑ Beneficio m√≠nimo ‚â• 30.000 ‚Ç¨
                </div>
            {% else %}
                <h3 class="text-danger fw-bold">‚úñ OPERACI√ìN NO VIABLE</h3>
                <p class="text-muted mb-0">
                    No alcanza los criterios m√≠nimos de rentabilidad
                </p>
                <div class="mt-2 small text-muted">
                    <strong>Criterios aplicados:</strong>
                    ROI m√≠nimo ‚â• 15 % ¬∑ Beneficio m√≠nimo ‚â• 30.000 ‚Ç¨
                </div>
            {% endif %}
        </div>

        <!-- TARJETA VISUAL DE RENTABILIDAD -->
        <div class="card mb-4 border-0 shadow-sm">
            <div class="card-body">
                <div class="row align-items-center text-center">
                    <div class="col-md-4 mb-3 mb-md-0">
                        <div class="fw-semibold text-muted">Rentabilidad global</div>
                        <div class="fs-3 fw-bold
                            {% if resultado.viable %}text-success
                            {% elif resultado.ajustada %}text-warning
                            {% else %}text-danger{% endif %}">
                            {{ resultado.roi }} %
                        </div>
                        <small class="text-muted">Objetivo ‚â• 15 %</small>
                    </div>

                    <div class="col-md-4 mb-3 mb-md-0">
                        <div class="fw-semibold text-muted">Beneficio esperado</div>
                        <div class="fs-3 fw-bold
                            {% if resultado.beneficio_neto >= 30000 %}text-success
                            {% elif resultado.beneficio_neto > 0 %}text-warning
                            {% else %}text-danger{% endif %}">
                            <span class="js-euro" data-value="{{ resultado.beneficio_neto }}"></span>
                        </div>
                        <small class="text-muted">Objetivo ‚â• 30.000 ‚Ç¨</small>
                    </div>

                    <div class="col-md-4">
                        <div class="fw-semibold text-muted">Decisi√≥n Inversure</div>
                        <div class="fs-5 fw-semibold">
                            {% if resultado.viable %}
                                ‚úÖ Apta para inversi√≥n
                            {% elif resultado.ajustada %}
                                ‚ö† Requiere ajuste
                            {% else %}
                                ‚ùå No invertir
                            {% endif %}
                        </div>
                        <small class="text-muted">
                            Basado en ROI y beneficio absoluto
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <!-- TARJETA DE AJUSTES NECESARIOS -->
        {% if not resultado.viable %}
        <div class="card mb-4 border-0 shadow-sm">
            <div class="card-body">
                <h5 class="fw-bold mb-3">üîß Qu√© habr√≠a que ajustar para que sea viable</h5>

                <div class="row text-center">
                    <div class="col-md-4 mb-3">
                        <div class="fw-semibold text-muted">Incrementar precio de venta</div>
                        <div class="fs-5 fw-bold text-warning">
                            <span class="js-euro" data-value="{{ resultado.ajuste_precio_venta }}"></span>
                        </div>
                        <small class="text-muted">Manteniendo gastos actuales</small>
                    </div>

                    <div class="col-md-4 mb-3">
                        <div class="fw-semibold text-muted">Reducir gastos totales</div>
                        <div class="fs-5 fw-bold text-warning">
                            <span class="js-euro" data-value="{{ resultado.ajuste_gastos }}"></span>
                        </div>
                        <small class="text-muted">Manteniendo precio de venta</small>
                    </div>

                    <div class="col-md-4 mb-3">
                        <div class="fw-semibold text-muted">Escenario combinado</div>
                        <div class="fs-6 fw-semibold">
                            Ajuste parcial en precio y gastos
                        </div>
                        <small class="text-muted">
                            Recomendado para negociaci√≥n
                        </small>
                    </div>
                </div>

                <div class="alert alert-light border mt-3 mb-0 small">
                    <strong>Nota:</strong> Estos ajustes son orientativos. No modifican el proyecto ni sus datos guardados.
                </div>
            </div>
        </div>
        {% endif %}

        <hr class="my-4">

        <!-- KPIs PRINCIPALES -->
        <div class="row text-center mb-4">
            <div class="col-md-3">
                <div class="fw-semibold text-muted">Beneficio neto</div>
                <div class="fs-4 fw-bold">
                    <span class="js-euro" data-value="{{ resultado.beneficio_neto }}"></span>
                </div>
                <small class="text-muted">Objetivo ‚â• 30.000 ‚Ç¨</small>
            </div>

            <div class="col-md-3">
                <div class="fw-semibold text-muted">ROI</div>
                <div class="fs-4 fw-bold">{{ resultado.roi }} %</div>
                <small class="text-muted">Objetivo ‚â• 15 %</small>
            </div>

            <div class="col-md-3">
                <div class="fw-semibold text-muted">Capital invertido</div>
                <div class="fs-5 fw-semibold">
                    <span class="js-euro" data-value="{{ resultado.valor_adquisicion }}"></span>
                </div>
            </div>

            <div class="col-md-3">
                <div class="fw-semibold text-muted">‚Ç¨ ganados / ‚Ç¨ invertido</div>
                <div class="fs-5 fw-semibold">
                    {{ resultado.ratio_euro }} ‚Ç¨
                </div>
            </div>
        </div>

        <hr class="my-4">

        <!-- M√âTRICAS INVERSOR -->
        <div class="row">
            <div class="col-md-4">
                <strong>Precio m√≠nimo de venta</strong><br>
                <span class="js-euro" data-value="{{ resultado.precio_minimo_venta }}"></span>
            </div>

            <div class="col-md-4">
                <strong>Colch√≥n de seguridad</strong><br>
                {{ resultado.colchon_seguridad }} %
            </div>

            <div class="col-md-4">
                <strong>Margen neto</strong><br>
                {{ resultado.margen_neto }} %
            </div>
        </div>

    </div>
</div>
{% endif %}
</form>
</div>


<script>
// ===== FORMATO MONETARIO √öNICO =====
function parseEuro(value) {
    if (!value) return 0;
    return Number(
        value
            .toString()
            .replace(/\./g, "")
            .replace(",", ".")
            .replace(" ‚Ç¨", "")
            .replace("‚Ç¨", "")
            .trim()
    ) || 0;
}

function formatEuro(value) {
    if (value === null || value === "" || isNaN(value)) return "";
    return new Intl.NumberFormat("es-ES", {
        style: "currency",
        currency: "EUR",
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    }).format(value);
}

function activarFormatoMonetarioInputs() {
    document.querySelectorAll('input[data-euro="true"]').forEach(input => {
        input.addEventListener("focus", () => {
            const v = parseEuro(input.value);
            input.value = v ? v.toString().replace(".", ",") : "";
        });

        input.addEventListener("blur", () => {
            const v = parseEuro(input.value);
            input.value = formatEuro(v || 0);
        });
    });
}

// --- FASE 1: Estado para detectar edici√≥n manual de precio de venta ---

let precioVentaManual = false;
let notariaManual = false;
let registroManual = false;
let itpManual = false;
let gestionComercialManual = false;
let gestionAdministracionManual = false;
// ===============================
// MEDIA DE VALORACIONES
// ===============================

function recalcMediaValoraciones() {
    const fields = [
        "val_idealista",
        "val_fotocasa",
        "val_registradores",
        "val_casafari",
        "val_tasacion"
    ];

    let total = 0;
    let count = 0;

    fields.forEach(name => {
        const el = document.querySelector(`[name="${name}"]`);
        if (!el) return;

        const value = parseEuro(el.value);
        if (value > 0) {
            total += value;
            count++;
        }
    });

    const media = count > 0 ? total / count : 0;

    const mediaInput = document.querySelector('[name="media_valoraciones"]');
    if (mediaInput) {
        mediaInput.value = formatEuro(media);
    }

    // Autocompletar precio de venta SOLO si no es manual
    const precioVenta = document.querySelector('[name="precio_venta_estimado"]');
    if (precioVenta && !precioVentaManual && media > 0) {
        precioVenta.value = formatEuro(media);
    }
}

// Listeners para recalcular al escribir
[
    "val_idealista",
    "val_fotocasa",
    "val_registradores",
    "val_casafari",
    "val_tasacion"
].forEach(name => {
    const el = document.querySelector(`[name="${name}"]`);
    if (el) {
        el.addEventListener("input", recalcMediaValoraciones);
        el.addEventListener("blur", recalcMediaValoraciones);
    }
});

function recalcPrecioCompraInmueble() {
    const precioPropiedad = parseEuro(
        document.querySelector('[name="precio_propiedad"]')?.value || 0
    );

    // Inputs (deben declararse antes de usarse)
    const notariaInput = document.querySelector('[name="notaria"]');
    const registroInput = document.querySelector('[name="registro"]');
    const itpInput = document.querySelector('[name="itp"]');

    // C√°lculos autom√°ticos
    const notariaAuto = Math.max(precioPropiedad * 0.002, 500);
    const registroAuto = Math.max(precioPropiedad * 0.002, 500);
    const itpAuto = precioPropiedad * 0.02;

    // Escribir valores autom√°ticos si no son manuales
    if (notariaInput && !notariaManual) {
        notariaInput.value = formatEuro(notariaAuto);
    }
    if (registroInput && !registroManual) {
        registroInput.value = formatEuro(registroAuto);
    }
    if (itpInput && !itpManual) {
        itpInput.value = formatEuro(itpAuto);
    }

    // Valores efectivos para c√°lculos
    let notariaVal = notariaManual ? parseEuro(notariaInput?.value) : notariaAuto;
    let registroVal = registroManual ? parseEuro(registroInput?.value) : registroAuto;
    let itpVal = itpManual ? parseEuro(itpInput?.value) : itpAuto;

    // --- Calcular suma de gastos para precio_compra_inmueble ---
    const gastos = [
        // Gastos de adquisici√≥n
        "otros_gastos_compra",

        // Inversi√≥n inicial
        "reforma",
        "limpieza_inicial",
        "mobiliario",
        "otros_puesta_marcha",

        // Gastos recurrentes
        "comunidad",
        "ibi",
        "seguros",
        "suministros",
        "limpieza_periodica",
        "ocupas",

        // Obra
        "obra_demoliciones",
        "obra_albanileria",
        "obra_fontaneria",
        "obra_electricidad",
        "obra_carpinteria_interior",
        "obra_carpinteria_exterior",
        "obra_cocina",
        "obra_banos",
        "obra_pintura",
        "obra_otros",

        // Seguridad
        "seguridad_cerrajero",
        "seguridad_alarma",

        // Gastos de venta
        "plusvalia",
        "inmobiliaria",
        "gestion_comercial",
        "gestion_administracion"
    ];

    // Para gestion_comercial y gestion_administracion, calcular autom√°ticamente si no manual, pero NO escribir en input
    // Calcular beneficio bruto: precio_venta_estimado - (precio_propiedad + resto_de_gastos_sin_comercializacion)
    const precioVentaEstimado = parseEuro(document.querySelector('[name="precio_venta_estimado"]')?.value || 0);

    // Gastos a excluir: gestion_comercial, gestion_administracion
    const gastosSinComercializacion = [
        ...gastos.filter(g => g !== "gestion_comercial" && g !== "gestion_administracion")
    ];
    let sumaGastosSinCom = 0;
    gastosSinComercializacion.forEach(name => {
        const el = document.querySelector(`[name="${name}"]`);
        if (el) sumaGastosSinCom += parseEuro(el.value);
    });
    // Sumar tambi√©n notaria, registro, itp calculados
    sumaGastosSinCom += notariaVal + registroVal + itpVal;
    const beneficioBruto = precioVentaEstimado - (precioPropiedad + sumaGastosSinCom);

    // gestion_comercial = manual o beneficio_bruto * 0.05
    const gestionComercialInput = document.querySelector('[name="gestion_comercial"]');
    let gestionComercialVal = gestionComercialInput ? parseEuro(gestionComercialInput.value) : 0;
    if (!gestionComercialManual) gestionComercialVal = beneficioBruto * 0.05 > 0 ? beneficioBruto * 0.05 : 0;
    // gestion_administracion = manual o beneficio_bruto * 0.05
    const gestionAdministracionInput = document.querySelector('[name="gestion_administracion"]');
    let gestionAdministracionVal = gestionAdministracionInput ? parseEuro(gestionAdministracionInput.value) : 0;
    if (!gestionAdministracionManual) gestionAdministracionVal = beneficioBruto * 0.05 > 0 ? beneficioBruto * 0.05 : 0;

    // Sumar todos los gastos
    let totalGastos = 0;
    // Sumar notaria, registro, itp calculados
    totalGastos += notariaVal + registroVal + itpVal;
    // Sumar el resto
    gastos.forEach(name => {
        // gestion_comercial y gestion_administracion: usar los valores calculados
        if (name === "gestion_comercial") {
            totalGastos += gestionComercialVal;
        } else if (name === "gestion_administracion") {
            totalGastos += gestionAdministracionVal;
        } else {
            const el = document.querySelector(`[name="${name}"]`);
            if (el) totalGastos += parseEuro(el.value);
        }
    });

    const total = precioPropiedad + totalGastos;
    const target = document.querySelector('[name="precio_compra_inmueble"]');
    if (target) {
        target.value = formatEuro(total);
    }
}



// Recalculate totals when editing ‚ÄúPrecio de escritura‚Äù
const precioEscrituraInput = document.querySelector('[name="precio_propiedad"]');
if (precioEscrituraInput) {
    precioEscrituraInput.addEventListener("input", () => {
        recalcPrecioCompraInmueble();
    });
}

// --- FASE 1: Detectar edici√≥n manual del precio de venta estimado ---
const precioVentaInput = document.querySelector('[name="precio_venta_estimado"]');
if (precioVentaInput) {
    precioVentaInput.addEventListener("input", () => {
        precioVentaManual = true;
    });
}

const notariaInputManual = document.querySelector('[name="notaria"]');
if (notariaInputManual) {
    notariaInputManual.addEventListener("input", () => {
        notariaManual = true;
    });
}

const registroInputManual = document.querySelector('[name="registro"]');
if (registroInputManual) {
    registroInputManual.addEventListener("input", () => {
        registroManual = true;
    });
}

const itpInputManual = document.querySelector('[name="itp"]');
if (itpInputManual) {
    itpInputManual.addEventListener("input", () => {
        itpManual = true;
    });
}

const gestionComercialInputManual = document.querySelector('[name="gestion_comercial"]');
if (gestionComercialInputManual) {
    gestionComercialInputManual.addEventListener("input", () => {
        gestionComercialManual = true;
    });
}

const gestionAdministracionInputManual = document.querySelector('[name="gestion_administracion"]');
if (gestionAdministracionInputManual) {
    gestionAdministracionInputManual.addEventListener("input", () => {
        gestionAdministracionManual = true;
    });
}
function verCatastro() {
    const ref = document.querySelector('[name="ref_catastral"]')?.value?.trim();

    // Catastro siempre abre
    let url = "https://www.sedecatastro.gob.es/";

    // Si hay referencia, llevamos al buscador
    if (ref) {
        url = "https://www.sedecatastro.gob.es/Accesos/SECAccesos.aspx";
    }

    window.open(url, "_blank", "noopener");
}

const refInput = document.querySelector('[name="ref_catastral"]');
const btnCatastro = document.getElementById("btnCatastro");

if (refInput && btnCatastro) {
    const toggleCatastroButton = () => {
        if (refInput.value.trim() !== "") {
            btnCatastro.style.opacity = "1";
            btnCatastro.style.filter = "none";
        } else {
            btnCatastro.style.opacity = "1";
            btnCatastro.style.filter = "grayscale(40%)";
        }
    };

    refInput.addEventListener("input", toggleCatastroButton);
    toggleCatastroButton();
}


function initManualFlags() {
    const map = [
        { name: "notaria", set: () => notariaManual = true },
        { name: "registro", set: () => registroManual = true },
        { name: "itp", set: () => itpManual = true },
        { name: "gestion_comercial", set: () => gestionComercialManual = true },
        { name: "gestion_administracion", set: () => gestionAdministracionManual = true },
        { name: "precio_venta_estimado", set: () => precioVentaManual = true }
    ];

    map.forEach(item => {
        const el = document.querySelector(`[name="${item.name}"]`);
        if (el && parseEuro(el.value) > 0) item.set();
    });
}

function activarListeners() {
    const escritura = document.querySelector('[name="precio_propiedad"]');
    if (escritura) {
        escritura.addEventListener("input", recalcPrecioCompraInmueble);
    }

    const manualInputs = [
        { name: "notaria", flag: () => notariaManual = true },
        { name: "registro", flag: () => registroManual = true },
        { name: "itp", flag: () => itpManual = true },
        { name: "gestion_comercial", flag: () => gestionComercialManual = true },
        { name: "gestion_administracion", flag: () => gestionAdministracionManual = true },
        { name: "precio_venta_estimado", flag: () => precioVentaManual = true }
    ];

    manualInputs.forEach(item => {
        const el = document.querySelector(`[name="${item.name}"]`);
        if (el) el.addEventListener("input", item.flag);
    });
}

document.addEventListener("DOMContentLoaded", () => {
    initManualFlags();
    activarFormatoMonetarioInputs();
    activarListeners();
    // Centralized formatting only on DOMContentLoaded for all euro inputs
    document.querySelectorAll('input[data-euro="true"]').forEach(i => {
        const v = parseEuro(i.value);
        if (v || v === 0) i.value = formatEuro(v);
    });
    recalcPrecioCompraInmueble();
    recalcMediaValoraciones();
});

</script>


{% endblock %}
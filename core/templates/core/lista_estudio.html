{% extends "core/base.html" %}
{% load static %}
{% load humanize %}
{% block content %}
<div class="inversure-app">
  <section class="inversure-section">
    <div class="container">

      <section class="inversure-section-header mb-5 text-center">
        <h1 class="inversure-section-title">Estudios</h1>
        <div class="inversure-divider mx-auto"></div>
        <p class="inversure-section-subtitle mx-auto">
          Estudios de viabilidad en fase de análisis
        </p>
      </section>

      {% if estudios %}
      <div class="row g-4">
        {% for estudio in estudios %}
        <div class="col-xl-3 col-lg-4 col-md-6">
          <div class="card h-100 shadow-sm inversure-card">
            <div class="card-header inversure-card-header text-white d-flex justify-content-between align-items-start" style="background-color:#122135;">
              <div>
                <div class="fw-bold">
                  {{ estudio.nombre|default:"Estudio sin nombre" }}
                </div>
                <div class="small opacity-75">
                  {{ estudio.direccion|default:"Sin dirección" }}
                </div>

                <div class="mt-2">
                  {% if estudio.roi >= 20 %}
                    <span class="badge bg-success">Muy viable</span>
                  {% elif estudio.roi >= 12 %}
                    <span class="badge bg-warning text-dark">Viable</span>
                  {% else %}
                    <span class="badge bg-danger">Revisar</span>
                  {% endif %}
                </div>
              </div>

              <span class="badge bg-light text-dark small align-self-start">
                ESTUDIO #{{ estudio.codigo_estudio }}
              </span>
            </div>

            <div class="card-body d-flex flex-column">
              <div class="mb-4 text-center inversure-kpis">
                <div class="fw-bold inversure-roi" style="font-size:1.8rem;">
                  {% if estudio.roi is not None %}
                    {% if estudio.roi < 0 %}
                      <span class="text-danger">{{ estudio.roi|floatformat:2 }}%</span>
                    {% elif estudio.roi < 12 %}
                      <span class="text-warning">{{ estudio.roi|floatformat:2 }}%</span>
                    {% else %}
                      <span class="text-success">{{ estudio.roi|floatformat:2 }}%</span>
                    {% endif %}
                  {% else %}
                    —
                  {% endif %}
                </div>
                <div class="fw-semibold small text-muted" title="ROI = Beneficio / Inversión total">ROI</div>
              </div>

              <div class="row text-center mb-4 inversure-kpis">
                <div class="col-6">
                  <div class="fw-semibold small text-muted" title="Capital total invertido en la operación">Inversión</div>
                  <div class="fw-bold">
                    {% if estudio.valor_adquisicion %}
                      {% widthratio estudio.valor_adquisicion 1000 1 %} k€
                    {% else %}
                      —
                    {% endif %}
                  </div>
                </div>
                <div class="col-6">
                  <div class="fw-semibold small text-muted" title="Beneficio estimado antes de impuestos">Beneficio</div>
                  <div class="fw-bold">
                    {% if estudio.beneficio %}
                      {% if estudio.beneficio < 0 %}
                        <span class="text-danger">
                          {% widthratio estudio.beneficio|floatformat:0 1000 1 %} k€
                        </span>
                      {% else %}
                        <span class="text-success">
                          {% widthratio estudio.beneficio 1000 1 %} k€
                        </span>
                      {% endif %}
                    {% else %}
                      —
                    {% endif %}
                  </div>
                </div>
              </div>

              <hr class="my-2">

              <div class="mt-auto d-flex justify-content-center gap-2">
                <a href="{% url 'core:simulador' %}?estudio_id={{ estudio.id }}"
                   class="btn btn-primary btn-sm">
                  Abrir
                </a>
                <button type="button"
                        class="btn btn-outline-danger btn-sm js-borrar-estudio"
                        data-id="{{ estudio.id }}">
                  Borrar
                </button>
              </div>
            </div>

            <div class="card-footer text-center small text-muted py-2">
              ID interno: {{ estudio.id }} · Creado: {{ estudio.fecha|date:"d/m/Y" }}
            </div>

          </div>
        </div>
        {% endfor %}
      </div>
      {% else %}
        <div class="text-center text-muted py-5">
          No hay estudios en curso.
        </div>
      {% endif %}

    </div>
  </section>
</div>
<style>
  .inversure-kpis .fw-semibold {
    font-size: 0.85rem;
    white-space: nowrap;
  }

  .inversure-kpis .fw-bold {
    font-size: 0.95rem;
  }
  .inversure-roi {
    font-size: 1.5rem;
  }
</style>
<script>
(function () {
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  const csrftoken = getCookie('csrftoken');

  document.addEventListener('click', function (e) {
    const btn = e.target.closest('.js-borrar-estudio');
    if (!btn) return;

    const estudioId = btn.dataset.id;
    if (!estudioId) return;

    if (!confirm('¿Seguro que quieres borrar este estudio?')) return;

    fetch(`/estudios/borrar/${estudioId}/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrftoken,
        'X-Requested-With': 'XMLHttpRequest'
      }
    })
    .then(res => {
      if (!res.ok) throw new Error('Error al borrar');
      // eliminar la card del DOM
      const card = btn.closest('.col-xl-3, .col-lg-4, .col-md-6');
      if (card) card.remove();
    })
    .catch(() => {
      alert('No se pudo borrar el estudio.');
    });
  });
})();
</script>
{% endblock %}
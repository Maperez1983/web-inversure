{% extends "core/base.html" %}
{% load humanize %}
{% block content %}

<div class="container py-5">

  <div class="card mb-4 rounded-3 overflow-hidden">
    <div class="px-4 py-3" style="background:#122135;">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <div class="fw-semibold text-white">
            Proyecto ¬∑ {{ proyecto.direccion|default:"Inversi√≥n inmobiliaria" }}
          </div>
          <div class="small text-light opacity-75">
            Estado general de la operaci√≥n
          </div>
        </div>

        <div class="d-flex gap-2">
          <a href="{% url 'core:memoria_economica' proyecto.id %}"
             class="btn btn-sm btn-outline-light">
            üìÑ Memoria
          </a>
          <a href="{% url 'core:lista_proyectos' %}"
             class="btn btn-sm btn-outline-light">
            ‚Üê Volver
          </a>
        </div>
      </div>
    </div>
    <!-- INDICADOR DE ESTADO / ALERTA -->
    {% comment %} INDICADOR DE ESTADO / ALERTA {% endcomment %}
    {% if capital_captado == 0 %}
      <div class="px-4 py-2 bg-warning bg-opacity-25 text-warning-emphasis small">
        ‚ö†Ô∏è Proyecto sin inversores todav√≠a
      </div>
    {% elif porcentaje_captado < 50 %}
      <div class="px-4 py-2 bg-info bg-opacity-25 text-info-emphasis small">
        ‚ÑπÔ∏è Captaci√≥n en curso ({{ porcentaje_captado|floatformat:0 }} %)
      </div>
    {% else %}
      <div class="px-4 py-2 bg-success bg-opacity-25 text-success-emphasis small">
        üü¢ Captaci√≥n avanzada ({{ porcentaje_captado|floatformat:0 }} %)
      </div>
    {% endif %}

    <div class="row text-center py-3">
      <div class="col-md-3">
        <div class="border rounded-3 py-3 bg-light">
          <div class="small text-muted">Capital objetivo</div>
          <div class="fs-5 fw-bold text-dark">
            {{ proyecto.capital_objetivo|default:0|floatformat:0|intcomma }} ‚Ç¨
          </div>
        </div>
      </div>

      <div class="col-md-3">
        <div class="border rounded-3 py-3 bg-light">
          <div class="small text-muted">Capital captado</div>
          <div class="fs-5 fw-bold text-dark">
            {{ capital_captado|floatformat:0|intcomma }} ‚Ç¨
          </div>
        </div>
      </div>

      <div class="col-md-3">
        <div class="border rounded-3 py-3 bg-light">
          <div class="small text-muted">Rentabilidad estimada</div>
          <div class="fs-5 fw-bold text-dark">
            {{ proyecto.rentabilidad_estimada|default:0|floatformat:2 }} %
          </div>
        </div>
      </div>

      <div class="col-md-3">
        <div class="border rounded-3 py-3 bg-light">
          <div class="small text-muted">Fase</div>
          <div class="fs-5 fw-bold text-dark">
            {% if proyecto.estado in "estudio reservado comprado" %}
              <span class="badge bg-warning text-dark">Captaci√≥n</span>
            {% elif proyecto.estado in "en_venta comercializacion publicado negociacion" %}
              <span class="badge bg-primary">Comercializaci√≥n</span>
            {% else %}
              <span class="badge bg-success">Cierre</span>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <div class="px-4 pb-3">
      <div class="progress rounded-pill" style="height:8px;">
        <div class="progress-bar
          {% if proyecto.estado in "estudio reservado comprado" %}
            bg-warning
          {% elif proyecto.estado in "en_venta comercializacion publicado negociacion" %}
            bg-primary
          {% else %}
            bg-success
          {% endif %}
        "
        role="progressbar"
        style="
          width:
          {% if proyecto.estado in "estudio reservado comprado" %}
            33%
          {% elif proyecto.estado in "en_venta comercializacion publicado negociacion" %}
            66%
          {% else %}
            100%
          {% endif %}
        ">
        </div>
      </div>
    </div>

    <div class="border rounded-3 p-3 bg-white">
      <!-- BLOQUE ESTADO DE LA INVERSI√ìN (GR√ÅFICO) -->
      <div class="row align-items-center">
        <div class="col-md-7">
          <ul class="mb-0 text-start">
            <li><span class="small text-muted">Capital objetivo:</span>
              <span class="fw-semibold">
                {{ proyecto.capital_objetivo|default:0|floatformat:0|intcomma }} ‚Ç¨
              </span>
            </li>
            <li><span class="small text-muted">Capital captado:</span>
              <span class="fw-semibold">
                {{ capital_captado|floatformat:0|intcomma }} ‚Ç¨
              </span>
            </li>
            <li><span class="small text-muted">Capital pendiente:</span>
              <span class="fw-semibold">
                {{ proyecto.capital_objetivo|default:0|floatformat:0|intcomma }} ‚Ç¨
              </span>
            </li>
          </ul>
        </div>

        <div class="col-md-5 text-center">
          <canvas id="capitalChart" style="max-width:240px; margin:auto; cursor:pointer;"></canvas>
          <div class="small text-muted mt-2">
            Clic para ver detalle econ√≥mico
          </div>
        </div>
      </div>
    </div>

    <div class="border-top pt-3 mt-3">
      <!-- BLOQUE ECON√ìMICO -->
      <div class="row text-center py-3">
        <div class="col-md-3">
          <div class="small text-muted">Compra</div>
          <div class="fw-semibold">
            {{ proyecto.precio_compra_estimado|default:0|floatformat:0|intcomma }} ‚Ç¨
          </div>
        </div>
        <div class="col-md-3">
          <div class="small text-muted">Costes</div>
          <div class="fw-semibold">
            {{ proyecto.costes_totales|default:0|floatformat:0|intcomma }} ‚Ç¨
          </div>
        </div>
        <div class="col-md-3">
          <div class="small text-muted">Venta</div>
          <div class="fw-semibold">
            {{ proyecto.precio_venta_estimado|default:0|floatformat:0|intcomma }} ‚Ç¨
          </div>
        </div>
        <div class="col-md-3">
          <div class="small text-muted">Rentabilidad</div>
          <div class="fw-semibold">
            {{ proyecto.rentabilidad_estimada|default:0|floatformat:2 }} %
          </div>
        </div>
      </div>
    </div>

    <!-- BLOQUE RESUMEN INVERSORES -->
    <div class="p-3 mb-4">
      <h6 class="mb-1">Inversores del proyecto</h6>
      <p class="text-muted mb-0">
        A√∫n no hay inversores asociados a este proyecto.
      </p>
    </div>

    <!-- BLOQUE INMUEBLE -->
    <div class="p-3 mb-4">
      <h6>Datos del inmueble</h6>
      <ul class="mb-0">
        <li><span class="small text-muted">Direcci√≥n:</span> <span class="fw-semibold">{{ proyecto.direccion|default:"--" }}</span></li>
        <li><span class="small text-muted">Referencia catastral:</span> <span class="fw-semibold">{{ proyecto.referencia_catastral|default:"--" }}</span></li>
        <li>
          <span class="small text-muted">Valor de referencia (Catastro):</span>
          <span class="fw-semibold">
            {{ proyecto.valor_referencia_catastral|default:"--"|intcomma }} ‚Ç¨
          </span>
        </li>
        <li><span class="small text-muted">Municipio:</span> <span class="fw-semibold">{{ proyecto.municipio|default:"--" }}</span></li>
      </ul>
    </div>

    <!-- MAPA DE UBICACI√ìN -->
    <div class="px-3 pb-4">
      <div class="border rounded-3 overflow-hidden">
        <iframe
          src="https://www.openstreetmap.org/export/embed.html?search={{ proyecto.direccion|urlencode }}"
          style="width:100%; height:240px; border:0;"
          loading="lazy">
        </iframe>
      </div>
      <div class="small text-muted mt-1">
        Ubicaci√≥n aproximada del inmueble
      </div>
    </div>

    <!-- BLOQUE DOCUMENTACI√ìN -->
    <div class="border-top pt-3 px-3 pb-4">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h6 class="mb-1">Documentaci√≥n del proyecto</h6>
          <div class="small text-muted">
            Escrituras, contratos, notas simples y otros documentos
          </div>
        </div>
        <a href="{% url 'core:proyecto_documentos' proyecto.id %}"
           class="btn btn-sm btn-outline-primary">
          A√±adir documento
        </a>
      </div>
    </div>

  </div>

</div>

<script>
  const capitalObjetivo = {{ proyecto.capital_objetivo|default:0 }};
  const capitalCaptado = {{ capital_captado|default:0 }};
  const capitalPendiente = capitalObjetivo - capitalCaptado;

  const ctx = document.getElementById('capitalChart');

  const capitalChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: ['Capital captado', 'Capital pendiente'],
      datasets: [{
        data: [capitalCaptado, capitalPendiente],
        backgroundColor: ['#1f9d55', '#d7b04c'],
        borderWidth: 0
      }]
    },
    options: {
      cutout: '70%',
      plugins: {
        legend: {
          position: 'bottom'
        }
      },
      onClick: function () {
        window.location.href = "{% url 'core:proyecto_gastos' proyecto.id %}";
      }
    }
  });
</script>

{% endblock %}
{% extends "core/base.html" %}
{% load humanize %}
{% block content %}

<div class="container py-5">

  <div class="card mb-4 rounded-3 overflow-hidden">
    <div class="px-4 py-3 text-white" style="background-color:#122135;">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h5 class="mb-0">Proyecto</h5>
          <div class="text-muted small">
            {{ proyecto.direccion|default:"Proyecto de inversi√≥n inmobiliaria" }}
          </div>
        </div>

        <div class="d-flex gap-2">
          <a href="{% url 'core:memoria_economica' proyecto.id %}"
             class="btn btn-outline-light btn-sm">
            üìÑ Memoria econ√≥mica
          </a>

          <a href="{% url 'core:lista_proyectos' %}"
             class="btn btn-outline-light btn-sm">
            ‚Üê Volver
          </a>
        </div>
      </div>
    </div>

    <div class="row text-center py-3">
      <div class="col-md-3">
        <div>
          <div class="small text-muted">Capital objetivo</div>
          <div class="fw-semibold">
            {{ proyecto.capital_objetivo|default:0|floatformat:0|intcomma }} ‚Ç¨
          </div>
        </div>
      </div>

      <div class="col-md-3">
        <div>
          <div class="small text-muted">Capital captado</div>
          <div class="fw-semibold">
            {{ capital_captado|floatformat:0|intcomma }} ‚Ç¨
          </div>
        </div>
      </div>

      <div class="col-md-3">
        <div>
          <div class="small text-muted">Rentabilidad estimada</div>
          <div class="fw-semibold">
            {{ proyecto.rentabilidad_estimada|default:0|floatformat:2 }} %
          </div>
        </div>
      </div>

      <div class="col-md-3">
        <div>
          <div class="small text-muted">Fase</div>
          <div class="fw-semibold">
            {% if proyecto.estado in "estudio reservado comprado" %}
              <span class="badge bg-warning text-dark">Captaci√≥n</span>
            {% elif proyecto.estado in "en_venta comercializacion publicado negociacion" %}
              <span class="badge bg-primary">Comercializaci√≥n</span>
            {% else %}
              <span class="badge bg-success">Cierre</span>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <div class="progress" style="height: 14px;">
      <div class="progress-bar
        {% if proyecto.estado in "estudio reservado comprado" %}
          bg-warning
        {% elif proyecto.estado in "en_venta comercializacion publicado negociacion" %}
          bg-primary
        {% else %}
          bg-success
        {% endif %}
      "
      role="progressbar"
      style="
        width:
        {% if proyecto.estado in "estudio reservado comprado" %}
          33%
        {% elif proyecto.estado in "en_venta comercializacion publicado negociacion" %}
          66%
        {% else %}
          100%
        {% endif %}
      ">
      </div>
    </div>

    <!-- BLOQUE ESTADO DE LA INVERSI√ìN (GR√ÅFICO) -->
    <div class="p-3">
      <div class="row align-items-center">
        <div class="col-md-7">
          <ul class="mb-0 text-start">
            <li>Capital objetivo:
              <span class="fw-semibold">
                {{ proyecto.capital_objetivo|default:0|floatformat:0|intcomma }} ‚Ç¨
              </span>
            </li>
            <li>Capital captado:
              <span class="fw-semibold">
                {{ capital_captado|floatformat:0|intcomma }} ‚Ç¨
              </span>
            </li>
            <li>Capital pendiente:
              <span class="fw-semibold">
                {{ proyecto.capital_objetivo|default:0|floatformat:0|intcomma }} ‚Ç¨
              </span>
            </li>
          </ul>
        </div>

        <div class="col-md-5 text-center">
          <canvas id="capitalChart" style="max-width:240px; margin:auto; cursor:pointer;"></canvas>
          <div class="small text-muted mt-2">
            Clic para ver detalle econ√≥mico
          </div>
        </div>
      </div>
    </div>

    <!-- BLOQUE ECON√ìMICO -->
    <div class="row text-center py-3">
      <div class="col-md-3">
        <div class="small text-muted">Compra</div>
        <div class="fw-semibold">
          {{ proyecto.precio_compra_estimado|default:0|floatformat:0|intcomma }} ‚Ç¨
        </div>
      </div>
      <div class="col-md-3">
        <div class="small text-muted">Costes</div>
        <div class="fw-semibold">
          {{ proyecto.costes_totales|default:0|floatformat:0|intcomma }} ‚Ç¨
        </div>
      </div>
      <div class="col-md-3">
        <div class="small text-muted">Venta</div>
        <div class="fw-semibold">
          {{ proyecto.precio_venta_estimado|default:0|floatformat:0|intcomma }} ‚Ç¨
        </div>
      </div>
      <div class="col-md-3">
        <div class="small text-muted">Rentabilidad</div>
        <div class="fw-semibold">
          {{ proyecto.rentabilidad_estimada|default:0|floatformat:2 }} %
        </div>
      </div>
    </div>

    <!-- BLOQUE INMUEBLE -->
    <div class="p-3 mb-4">
      <h6>Datos del inmueble</h6>
      <ul class="mb-0">
        <li>Direcci√≥n: {{ proyecto.direccion|default:"--" }}</li>
        <li>Referencia catastral: {{ proyecto.referencia_catastral|default:"--" }}</li>
        <li>Municipio: {{ proyecto.municipio|default:"--" }}</li>
      </ul>
    </div>

    <!-- BLOQUE PART√çCIPES -->
    <div class="p-3 mb-4">
      <h6>Part√≠cipes / Inversores</h6>
      <p class="text-muted mb-0">
        A√∫n no hay inversores asociados a este proyecto.
      </p>
    </div>

  </div>

</div>

<script>
  const capitalObjetivo = {{ proyecto.capital_objetivo|default:0 }};
  const capitalCaptado = {{ capital_captado|default:0 }};
  const capitalPendiente = capitalObjetivo - capitalCaptado;

  const ctx = document.getElementById('capitalChart');

  const capitalChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: ['Capital captado', 'Capital pendiente'],
      datasets: [{
        data: [capitalCaptado, capitalPendiente],
        backgroundColor: ['#1f9d55', '#d7b04c'],
        borderWidth: 0
      }]
    },
    options: {
      cutout: '70%',
      plugins: {
        legend: {
          position: 'bottom'
        }
      },
      onClick: function () {
        window.location.href = "{% url 'core:proyecto_gastos' proyecto.id %}";
      }
    }
  });
</script>

{% endblock %}
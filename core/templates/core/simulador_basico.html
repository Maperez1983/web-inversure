{% extends "core/base.html" %}
{% load static %}
{% load humanize %}

{% block title %}Análisis previo de operación{% endblock %}

{% block content %}
<div class="inversure-app">
<section class="inversure-section">
    <div class="container">

    <section class="inversure-section-header mb-5 text-center">
        <div class="inversure-section-icon mb-2">
            <i class="bi bi-graph-up"></i>
        </div>
        <h1 class="inversure-section-title">Análisis previo de operación</h1>
        <div class="inversure-divider mx-auto"></div>
        <p class="inversure-section-subtitle mx-auto">
            Evaluación rápida para decidir si una operación merece un estudio completo.
        </p>
    </section>

    <form method="post">
        {% csrf_token %}

        <div class="row g-4">

            <!-- COLUMNA IZQUIERDA -->
            <div class="col-md-6">
                <div class="card shadow-sm">
                    <div class="card-body">

                        <h5 class="card-title mb-3">Datos básicos del inmueble</h5>

                        <div class="mb-3">
                            <label class="form-label">Dirección del inmueble *</label>
                            <input type="text" name="direccion" class="form-control"
                                   value="{{ direccion|default:'' }}" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Referencia catastral</label>
                            <input type="text" name="ref_catastral" class="form-control"
                                   value="{{ ref_catastral|default:'' }}">
                        </div>

                    </div>
                </div>
            </div>

            <!-- COLUMNA DERECHA -->
            <div class="col-md-6">
                <div class="card shadow-sm">
                    <div class="card-body">

                        <h5 class="card-title mb-3">Datos económicos</h5>

                        <div class="mb-3">
                            <label class="form-label">Precio de adquisición (€)</label>
                            <input type="text" name="precio_compra" class="form-control euro-input"
                                   placeholder="145.000,00"
                                   value="{{ precio_compra|default:'' }}" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Valor estimado de venta (€)</label>
                            <input type="text" name="precio_venta" class="form-control euro-input"
                                   placeholder="185.000,00"
                                   value="{{ precio_venta|default:'' }}" required>
                        </div>

                    </div>
                </div>
            </div>

        </div>

        <div class="inv-actions mt-4">
            <div class="inv-actions-inner justify-content-end">
                <button type="submit" class="btn btn-primary px-4">
                    Analizar viabilidad
                </button>
            </div>
        </div>

    </form>

    {% if resultado %}
    <hr class="my-4" id="resultado-analisis">

    <div class="row g-4">

        <div class="col-md-8">
            <div class="card border-0 shadow-sm">
                <div class="card-body">

                    <h5 class="card-title mb-3">Resultado del análisis previo</h5>

                    <ul class="list-group list-group-flush">
                        <li class="list-group-item">
                            <strong>Inversión total:</strong>
                            {{ resultado.inversion_total|floatformat:2|intcomma }} €
                        </li>
                        <li class="list-group-item">
                            <strong>Beneficio:</strong>
                            {{ resultado.beneficio|floatformat:2|intcomma }} €
                        </li>
                        <li class="list-group-item">
                            <strong>ROI:</strong>
                            {{ resultado.roi|floatformat:2 }} %
                        </li>
                        <li class="list-group-item">
                            <strong>Viabilidad:</strong>
                            {% if resultado.viable %}
                                <span class="badge bg-success">Análisis favorable</span>
                            {% else %}
                                <span class="badge bg-danger">Análisis desfavorable</span>
                            {% endif %}
                        </li>
                    </ul>

                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card border-0 shadow-sm">
                <div class="card-body">

                    <h5 class="card-title mb-3">Acciones</h5>

                    <form method="post" action="{% url 'core:guardar_simulacion' %}">
                        {% csrf_token %}
                        <input type="hidden" name="direccion" value="{{ direccion }}">
                        <input type="hidden" name="ref_catastral" value="{{ ref_catastral }}">
                        <input type="hidden" name="precio_compra" value="{{ precio_compra }}">
                        <input type="hidden" name="precio_venta" value="{{ precio_venta }}">
                        <input type="hidden" name="beneficio" value="{{ resultado.beneficio }}">
                        <input type="hidden" name="roi" value="{{ resultado.roi }}">
                        <button type="submit" class="btn btn-outline-primary w-100 mb-2">
                            Convertir a estudio
                        </button>
                    </form>

                    <a href="{% url 'core:simulador_basico' %}" class="btn btn-outline-danger w-100">
                        Borrar análisis
                    </a>

                    <div class="alert alert-info small mt-3 mb-0">
                    Este análisis previo no implica compromiso ni inversión.
                    Sirve únicamente para decidir si la operación merece un estudio completo.
                    </div>

                </div>
            </div>
        </div>

    </div>
    {% endif %}

    </div>
</section>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function () {
  function toNumberEU(v) {
    if (!v) return null;
    const n = v.replace(/\./g, '').replace(',', '.').replace(/[^0-9.]/g, '');
    const num = Number(n);
    return isNaN(num) ? null : num;
  }

  function formatEU(num) {
    return num.toLocaleString('es-ES', {
      minimumFractionDigits: 2,
      maximumFractionDigits: 2
    });
  }

  function forceFormatAll() {
    document.querySelectorAll('.euro-input').forEach(input => {
      const num = toNumberEU(input.value);
      if (num !== null) {
        input.value = formatEU(num);
      }
    });
  }

  // 1) Al cargar la página (GET y POST)
  window.addEventListener('load', forceFormatAll);

  // 1b) También al volver atrás (bfcache) o cuando el navegador restaura inputs
  window.addEventListener('pageshow', function () {
    setTimeout(forceFormatAll, 0);
  });

  // 2) Mientras se escribe
  document.addEventListener('input', function (e) {
    if (e.target.classList.contains('euro-input')) {
      const num = toNumberEU(e.target.value);
      if (num !== null) {
        e.target.dataset.raw = num;
      }
    }
  });

  // 3) Al salir del campo
  document.addEventListener('blur', function (e) {
    if (e.target.classList.contains('euro-input')) {
      const num = toNumberEU(e.target.value);
      if (num !== null) {
        e.target.value = formatEU(num);
      }
    }
  }, true);
  // 4) Antes de enviar el formulario → forzar formato euro
  const form = document.querySelector('form');
  if (form) {
    form.addEventListener('submit', function () {
      document.querySelectorAll('.euro-input').forEach(input => {
        const num = toNumberEU(input.value);
        if (num !== null) {
          input.value = formatEU(num);
        }
      });
    });
  }

  window.addEventListener('load', function () {
    const el = document.getElementById('resultado-analisis');
    if (el) {
      el.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  });
})();
</script>
{% endblock %}
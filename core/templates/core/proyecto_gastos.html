{% extends "core/base.html" %}
{% load humanize %}

{% block content %}
<div class="container-fluid">

  <!-- CABECERA: Identidad del Proyecto -->
  <div class="mb-4">
    <h3 class="fw-semibold mb-1">Proyecto · {{ proyecto.nombre }}</h3>
    <p class="text-muted mb-0">
      {% if proyecto.direccion %}
        {{ proyecto.direccion }}
      {% endif %}
    </p>
  </div>

  <form method="post">
    {% csrf_token %}
    <input type="hidden" name="form_tipo" value="datos_economicos">


    <!-- CABECERA ECONÓMICA DEL PROYECTO -->
    <div class="row g-3 mb-4">
      <div class="col-md-3">
        <div class="card shadow-sm border-start border-4 border-primary">
          <div class="card-body">
            <div class="small text-muted">Valor de adquisición total</div>
            <div class="fs-5 fw-semibold">
              <span id="card-valor-adquisicion">{{ valor_adquisicion_total }}</span> €
            </div>
            <div class="small text-muted">
              Escritura + gastos
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card shadow-sm">
          <div class="card-body">
            <div class="small text-muted">Precio de escritura</div>
            <div class="fs-5 fw-semibold text-end">
              {{ datos_economicos.precio_escritura|default_if_none:0|floatformat:2|intcomma }} €
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card shadow-sm">
          <div class="card-body">
            <div class="small text-muted">Total gastos acumulados</div>
            <div class="fs-5 fw-semibold text-end">
              <span id="card-total-gastos">{{ total_gastos }}</span> €
            </div>
            <div class="small text-muted">
              Ordinarios + extraordinarios
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card shadow-sm border-start border-4 border-success">
          <div class="card-body">
            <label class="small text-muted mb-1">Valor de transmisión estimado</label>
            <div class="input-group">
              <input
                type="number"
                step="0.01"
                class="form-control fw-semibold text-end"
                name="valor_transmision_estimado"
                value="{{ datos_economicos.valor_transmision_estimado|default_if_none:'' }}"
              >
              <span class="input-group-text">€</span>
            </div>
            <div class="small text-muted">
              Estimación editable hasta venta real
            </div>
          </div>
        </div>
      </div>
    </div>

    <hr>

    <!-- BLOQUE A — Gastos de adquisición -->
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-light fw-semibold">
        Gastos de adquisición
      </div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-6">
            <div class="d-flex align-items-center justify-content-between gap-2 p-2 border rounded">
              <span>Precio de escritura</span>
              <input type="number" step="0.01" class="form-control text-end" name="precio_escritura" value="{{ gastos_base.precio_escritura|default_if_none:'' }}">
              <select name="estado_precio_escritura" class="form-select form-select-sm" style="width: auto;">
                <option value="estimado" {% if gastos_base.estado_precio_escritura == "estimado" %}selected{% endif %}>estimado</option>
                <option value="real" {% if gastos_base.estado_precio_escritura == "real" %}selected{% endif %}>real</option>
              </select>
            </div>
          </div>
          <div class="col-md-6">
            <div class="d-flex align-items-center justify-content-between gap-2 p-2 border rounded">
              <span>ITP / Impuestos</span>
              <input type="number" step="0.01" class="form-control text-end" name="impuestos" value="{{ gastos_base.impuestos|default_if_none:'' }}">
              <select name="estado_impuestos" class="form-select form-select-sm" style="width: auto;">
                <option value="estimado" {% if gastos_base.estado_impuestos == "estimado" %}selected{% endif %}>estimado</option>
                <option value="real" {% if gastos_base.estado_impuestos == "real" %}selected{% endif %}>real</option>
              </select>
            </div>
          </div>
          <div class="col-md-6">
            <div class="d-flex align-items-center justify-content-between gap-2 p-2 border rounded">
              <span>Notaría</span>
              <input type="number" step="0.01" class="form-control text-end" name="notaria" value="{{ gastos_base.notaria|default_if_none:'' }}">
              <select name="estado_notaria" class="form-select form-select-sm" style="width: auto;">
                <option value="estimado" {% if gastos_base.estado_notaria == "estimado" %}selected{% endif %}>estimado</option>
                <option value="real" {% if gastos_base.estado_notaria == "real" %}selected{% endif %}>real</option>
              </select>
            </div>
          </div>
          <div class="col-md-6">
            <div class="d-flex align-items-center justify-content-between gap-2 p-2 border rounded">
              <span>Registro</span>
              <input type="number" step="0.01" class="form-control text-end" name="registro" value="{{ gastos_base.registro|default_if_none:'' }}">
              <select name="estado_registro" class="form-select form-select-sm" style="width: auto;">
                <option value="estimado" {% if gastos_base.estado_registro == "estimado" %}selected{% endif %}>estimado</option>
                <option value="real" {% if gastos_base.estado_registro == "real" %}selected{% endif %}>real</option>
              </select>
            </div>
          </div>
          <div class="col-md-6">
            <div class="d-flex align-items-center justify-content-between gap-2 p-2 border rounded">
              <span>Gestoría</span>
              <input type="number" step="0.01" class="form-control text-end" name="gestoria" value="{{ gastos_base.gestoria|default_if_none:'' }}">
              <select name="estado_gestoria" class="form-select form-select-sm" style="width: auto;">
                <option value="estimado" {% if gastos_base.estado_gestoria == "estimado" %}selected{% endif %}>estimado</option>
                <option value="real" {% if gastos_base.estado_gestoria == "real" %}selected{% endif %}>real</option>
              </select>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- BLOQUE B — Gastos de mantenimiento / holding -->
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-light fw-semibold">
        Gastos de mantenimiento / holding
      </div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-6">
            <div class="d-flex align-items-center justify-content-between gap-2 p-2 border rounded">
              <span>IBI</span>
              <input type="number" step="0.01" class="form-control text-end" name="ibi" value="{{ gastos_base.ibi|default_if_none:'' }}">
              <select name="estado_ibi" class="form-select form-select-sm" style="width: auto;">
                <option value="estimado" {% if gastos_base.estado_ibi == "estimado" %}selected{% endif %}>estimado</option>
                <option value="real" {% if gastos_base.estado_ibi == "real" %}selected{% endif %}>real</option>
              </select>
            </div>
          </div>
          <div class="col-md-6">
            <div class="d-flex align-items-center justify-content-between gap-2 p-2 border rounded">
              <span>Comunidad</span>
              <input type="number" step="0.01" class="form-control text-end" name="comunidad" value="{{ gastos_base.comunidad|default_if_none:'' }}">
              <select name="estado_comunidad" class="form-select form-select-sm" style="width: auto;">
                <option value="estimado" {% if gastos_base.estado_comunidad == "estimado" %}selected{% endif %}>estimado</option>
                <option value="real" {% if gastos_base.estado_comunidad == "real" %}selected{% endif %}>real</option>
              </select>
            </div>
          </div>
          <div class="col-md-6">
            <div class="d-flex align-items-center justify-content-between gap-2 p-2 border rounded">
              <span>Luz</span>
              <input type="number" step="0.01" class="form-control text-end" name="luz" value="{{ gastos_base.luz|default_if_none:'' }}">
              <select name="estado_luz" class="form-select form-select-sm" style="width: auto;">
                <option value="estimado" {% if gastos_base.estado_luz == "estimado" %}selected{% endif %}>estimado</option>
                <option value="real" {% if gastos_base.estado_luz == "real" %}selected{% endif %}>real</option>
              </select>
            </div>
          </div>
          <div class="col-md-6">
            <div class="d-flex align-items-center justify-content-between gap-2 p-2 border rounded">
              <span>Agua</span>
              <input type="number" step="0.01" class="form-control text-end" name="agua" value="{{ gastos_base.agua|default_if_none:'' }}">
              <select name="estado_agua" class="form-select form-select-sm" style="width: auto;">
                <option value="estimado" {% if gastos_base.estado_agua == "estimado" %}selected{% endif %}>estimado</option>
                <option value="real" {% if gastos_base.estado_agua == "real" %}selected{% endif %}>real</option>
              </select>
            </div>
          </div>
          <div class="col-md-6">
            <div class="d-flex align-items-center justify-content-between gap-2 p-2 border rounded">
              <span>Alarma</span>
              <input type="number" step="0.01" class="form-control text-end" name="alarma" value="{{ gastos_base.alarma|default_if_none:'' }}">
              <select name="estado_alarma" class="form-select form-select-sm" style="width: auto;">
                <option value="estimado" {% if gastos_base.estado_alarma == "estimado" %}selected{% endif %}>estimado</option>
                <option value="real" {% if gastos_base.estado_alarma == "real" %}selected{% endif %}>real</option>
              </select>
            </div>
          </div>
          <div class="col-md-6">
            <div class="d-flex align-items-center justify-content-between gap-2 p-2 border rounded">
              <span>Cerrajero</span>
              <input type="number" step="0.01" class="form-control text-end" name="cerrajero" value="{{ gastos_base.cerrajero|default_if_none:'' }}">
              <select name="estado_cerrajero" class="form-select form-select-sm" style="width: auto;">
                <option value="estimado" {% if gastos_base.estado_cerrajero == "estimado" %}selected{% endif %}>estimado</option>
                <option value="real" {% if gastos_base.estado_cerrajero == "real" %}selected{% endif %}>real</option>
              </select>
            </div>
          </div>
          <div class="col-md-6">
            <div class="d-flex align-items-center justify-content-between gap-2 p-2 border rounded">
              <span>Limpieza / Vaciado</span>
              <input type="number" step="0.01" class="form-control text-end" name="limpieza_vaciado" value="{{ gastos_base.limpieza_vaciado|default_if_none:'' }}">
              <select name="estado_limpieza_vaciado" class="form-select form-select-sm" style="width: auto;">
                <option value="estimado" {% if gastos_base.estado_limpieza_vaciado == "estimado" %}selected{% endif %}>estimado</option>
                <option value="real" {% if gastos_base.estado_limpieza_vaciado == "real" %}selected{% endif %}>real</option>
              </select>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- BLOQUE C — Gastos de comercialización y gestión -->
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-light fw-semibold">
        Gastos de comercialización y gestión
      </div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-6">
            <div class="d-flex align-items-center justify-content-between gap-2 p-2 border rounded">
              <span>Comercialización</span>
              <input type="number" step="0.01" class="form-control text-end" name="comercializacion" value="{{ gastos_base.comercializacion|default_if_none:'' }}">
              <select name="estado_comercializacion" class="form-select form-select-sm" style="width: auto;">
                <option value="estimado" {% if gastos_base.estado_comercializacion == "estimado" %}selected{% endif %}>estimado</option>
                <option value="real" {% if gastos_base.estado_comercializacion == "real" %}selected{% endif %}>real</option>
              </select>
            </div>
          </div>
          <div class="col-md-6">
            <div class="d-flex align-items-center justify-content-between gap-2 p-2 border rounded">
              <span>Administración</span>
              <input type="number" step="0.01" class="form-control text-end" name="administracion" value="{{ gastos_base.administracion|default_if_none:'' }}">
              <select name="estado_administracion" class="form-select form-select-sm" style="width: auto;">
                <option value="estimado" {% if gastos_base.estado_administracion == "estimado" %}selected{% endif %}>estimado</option>
                <option value="real" {% if gastos_base.estado_administracion == "real" %}selected{% endif %}>real</option>
              </select>
            </div>
          </div>
          <div class="col-md-6">
            <div class="d-flex align-items-center justify-content-between gap-2 p-2 border rounded">
              <span>Comisión Inversure</span>
              <input type="number" step="0.01" class="form-control text-end" name="comision_inversure" value="{{ gastos_base.comision_inversure|default_if_none:'' }}">
              <select name="estado_comision_inversure" class="form-select form-select-sm" style="width: auto;">
                <option value="estimado" {% if gastos_base.estado_comision_inversure == "estimado" %}selected{% endif %}>estimado</option>
                <option value="real" {% if gastos_base.estado_comision_inversure == "real" %}selected{% endif %}>real</option>
              </select>
            </div>
          </div>
        </div>
      </div>
    </div>

    <hr>

    <!-- BLOQUE: Gastos extraordinarios -->
    <!-- Gastos extraordinarios registrados en la operación -->
    <div class="card shadow-sm border-start border-4 border-danger">
      <div class="card-header bg-light fw-semibold">
        Gastos extraordinarios
      </div>

      {% if gastos_extraordinarios %}
      <div class="table-responsive">
        <table class="table table-striped mb-0">
          <thead class="table-light">
            <tr>
              <th>Concepto</th>
              <th class="text-end">Importe</th>
              <th>Fecha</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            {% for gasto in gastos_extraordinarios %}
            <tr>
              <td>{{ gasto.concepto }}</td>
              <td class="text-end">{{ gasto.importe|floatformat:2|intcomma }} €</td>
              <td>{{ gasto.fecha|date:"d/m/Y" }}</td>
              <td class="text-end">
                <a href="{{ gasto.justificante.url }}" class="btn btn-sm btn-outline-secondary" target="_blank" rel="noopener noreferrer">Justificante</a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
        <div class="p-4 text-center text-muted">No hay gastos extraordinarios registrados.</div>
      {% endif %}
    </div>

    <div class="position-sticky bottom-0 bg-white border-top py-3 d-flex justify-content-end">
      <button type="submit" class="btn btn-primary">Guardar cambios económicos</button>
    </div>
  </form>

</div>
<script>
  (function() {
    const form = document.querySelector('form');
    if (!form) return;

    const totalGastosSpan = document.getElementById('card-total-gastos');
    const valorAdquisicionSpan = document.getElementById('card-valor-adquisicion');

    const numberInputs = form.querySelectorAll('input[type="number"]');

    const formatter = new Intl.NumberFormat('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

    function recalculate() {
      let totalGastos = 0;
      let precioEscritura = 0;

      numberInputs.forEach(input => {
        const name = input.name;
        if (!name) return;
        if (name === 'valor_transmision_estimado') return;

        const val = parseFloat(input.value);
        if (isNaN(val)) return;

        if (name === 'precio_escritura') {
          precioEscritura = val;
        } else {
          totalGastos += val;
        }
      });

      const valorAdquisicion = precioEscritura + totalGastos;

      totalGastosSpan.textContent = formatter.format(totalGastos);
      valorAdquisicionSpan.textContent = formatter.format(valorAdquisicion);
    }

    numberInputs.forEach(input => {
      input.addEventListener('input', recalculate);
    });

    // Initial calculation on page load
    recalculate();
  })();
</script>
{% endblock %}
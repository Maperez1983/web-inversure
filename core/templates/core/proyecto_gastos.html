{% extends "core/base.html" %}
{% load humanize %}

{% block content %}

<div class="container mt-4">

    <!-- TÍTULO -->
    <div class="card mb-4 shadow-sm rounded-3 overflow-hidden">
      <div class="px-4 py-3" style="background-color:#122135;">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h3 class="mb-0 text-white">Datos económicos</h3>
            <small class="text-light">
              Edición y control de los datos económicos del proyecto
            </small>
          </div>

          <a href="{% url 'core:lista_proyectos' %}"
             class="btn btn-outline-light btn-sm">
            ← Volver a proyectos
          </a>
        </div>
      </div>
    </div>

    <!-- INFO PROYECTO -->
    <div class="card mb-4 shadow-sm rounded-3">
        <div class="card-body">
            <h5 class="card-title">{{ proyecto.nombre }}</h5>
            <p class="mb-1"><strong>Estado:</strong> {{ proyecto.get_estado_display }}</p>
            <p class="mb-0">
                <strong>Fecha creación:</strong> {{ proyecto.fecha_creacion|date:"d/m/Y" }}
            </p>
        </div>
    </div>

    <!-- ESTADO DE LA OPERACIÓN -->
    <div class="card mb-4 shadow-sm rounded-3">
      <div class="card-body">
        <h5 class="card-title">Estado de la operación</h5>
        <p class="text-muted mb-2">
          Este estado define la situación real del proyecto y condiciona su operativa económica.
        </p>

        <form method="post" class="mt-2">
          {% csrf_token %}

          <select name="estado" class="form-select w-auto">
            <option value="estudio" {% if proyecto.estado == "estudio" %}selected{% endif %}>En estudio</option>
            <option value="reservado" {% if proyecto.estado == "reservado" %}selected{% endif %}>Reservado</option>
            <option value="comprado" {% if proyecto.estado == "comprado" %}selected{% endif %}>Comprado</option>
            <option value="operacion" {% if proyecto.estado == "operacion" %}selected{% endif %}>En operación</option>
            <option value="vendido" {% if proyecto.estado == "vendido" %}selected{% endif %}>Vendido</option>
            <option value="descartado" {% if proyecto.estado == "descartado" %}selected{% endif %}>Descartado</option>
          </select>

          <div class="alert alert-light mt-3 mb-2 small">
            El estado del proyecto se gestiona desde este apartado y condiciona la operativa económica.
          </div>

          <div class="text-end">
            <button type="submit" class="btn btn-outline-primary btn-sm">
              Guardar estado
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- BOTÓN NUEVO GASTO -->
    <div class="mb-3">
        <a href="#" class="btn btn-outline-primary btn-sm">
            + Añadir gasto
        </a>
    </div>

    <!-- DATOS DE ADQUISICIÓN -->
    <div class="card mb-4 shadow-sm rounded-3">
      <div class="card-body">
        <form method="post">
          {% csrf_token %}
        <h5 class="card-title">Datos de adquisición</h5>
        <div class="row">
          <div class="col-md-4 mb-3">
            <label class="form-label">Precio de compra</label>
            <input type="number"
                   name="precio_compra_inmueble"
                   step="0.01"
                   class="form-control"
                   value="{{ proyecto.precio_compra_inmueble|default_if_none:'' }}">
          </div>

          <div class="col-md-4 mb-3">
            <label class="form-label">Fecha de compra</label>
            <input type="date"
                   name="fecha_compra"
                   class="form-control"
                   value="{{ proyecto.fecha_compra|date:'Y-m-d' }}">
          </div>

          <div class="col-md-4 mb-3">
            <label class="form-label">Tipo de adquisición</label>
            <select name="tipo_adquisicion" class="form-select">
              <option value="">—</option>
              <option value="directa" {% if proyecto.tipo_adquisicion == "directa" %}selected{% endif %}>Compra directa</option>
              <option value="deuda" {% if proyecto.tipo_adquisicion == "deuda" %}selected{% endif %}>Compra de deuda</option>
              <option value="subasta" {% if proyecto.tipo_adquisicion == "subasta" %}selected{% endif %}>Subasta</option>
              <option value="dacion" {% if proyecto.tipo_adquisicion == "dacion" %}selected{% endif %}>Dación en pago</option>
            </select>
          </div>
        </div>

        <hr>

        <div class="row">
          <div class="col-md-3 mb-3">
            <label class="form-label">Impuesto</label>
            <select name="impuesto_tipo" class="form-select">
              <option value="">—</option>
              <option value="ITP" {% if proyecto.impuesto_tipo == "ITP" %}selected{% endif %}>ITP</option>
              <option value="IVA" {% if proyecto.impuesto_tipo == "IVA" %}selected{% endif %}>IVA</option>
            </select>
          </div>

          <div class="col-md-3 mb-3">
            <label class="form-label">% Impuesto</label>
            <input type="number"
                   name="impuesto_porcentaje"
                   step="0.01"
                   class="form-control"
                   value="{{ proyecto.impuesto_porcentaje|default_if_none:'' }}">
          </div>

          <div class="col-md-3 mb-3">
            <label class="form-label">Importe impuesto</label>
            <input type="number"
                   name="itp"
                   step="0.01"
                   class="form-control"
                   value="{{ proyecto.itp|default_if_none:'' }}">
          </div>
        </div>

        <hr>

        <div class="row">
          <div class="col-md-3 mb-3">
            <label class="form-label">Notaría</label>
            <input type="number"
                   step="0.01"
                   class="form-control"
                   name="notaria"
                   value="{{ proyecto.notaria|default_if_none:'' }}">
          </div>

          <div class="col-md-3 mb-3">
            <label class="form-label">Registro</label>
            <input type="number"
                   step="0.01"
                   class="form-control"
                   name="registro"
                   value="{{ proyecto.registro|default_if_none:'' }}">
          </div>

          <div class="col-md-3 mb-3">
            <label class="form-label">Gestoría</label>
            <input type="number"
                   step="0.01"
                   class="form-control"
                   name="gestoria"
                   value="{{ proyecto.gestoria|default_if_none:'' }}">
          </div>
        </div>
        <div class="text-end mt-3">
          <button type="submit" class="btn btn-primary btn-sm">
            Guardar datos de adquisición
          </button>
        </div>
      </form>
      </div>
    </div>

    <!-- COSTES DE OPERACIÓN / MEJORA -->
    <div class="card mb-4 shadow-sm rounded-3">
      <div class="card-body">
        <h5 class="card-title">Costes de operación y mejora</h5>
        <p class="text-muted mb-0">
          Gastos derivados de la gestión, adecuación o explotación del inmueble.
        </p>
        <div class="alert alert-light mt-3 mb-0 small">
          Estos costes son variables y solo deben incluirse si el proyecto lo requiere.
        </div>
      </div>
    </div>

    <!-- INGRESOS DEL PROYECTO -->
    <div class="card mb-4 shadow-sm rounded-3">
      <div class="card-body">
        <h5 class="card-title">Ingresos del proyecto</h5>
        <p class="text-muted mb-0">
          Entradas económicas vinculadas al proyecto: señales, alquileres o venta.
        </p>
        <form method="post" class="mt-3">
          {% csrf_token %}
        <div class="row">
          <div class="col-md-4 mb-3">
            <label class="form-label">Tipo de ingreso</label>
            <select name="tipo_ingreso" class="form-select">
              <option value="">—</option>
              <option value="senal">Señal / Arras</option>
              <option value="alquiler">Alquiler</option>
              <option value="venta">Venta</option>
              <option value="otro">Otro ingreso</option>
            </select>
          </div>

          <div class="col-md-4 mb-3">
            <label class="form-label">Fecha</label>
            <input type="date" name="fecha_ingreso" class="form-control">
          </div>

          <div class="col-md-4 mb-3">
            <label class="form-label">Importe</label>
            <input type="number" step="0.01" name="importe_ingreso" class="form-control">
          </div>
        </div>
        <div class="text-end">
          <button type="submit" class="btn btn-primary btn-sm">
            Guardar ingreso
          </button>
        </div>
        </form>
      </div>
    </div>

    <!-- TABLA DE GASTOS -->
    <div class="card shadow-sm rounded-3">
        <div class="card-body p-0">

            {% if gastos %}
                <table class="table table-striped mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Concepto</th>
                            <th>Tipo</th>
                            <th class="text-end">Importe</th>
                            <th>Fecha</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for gasto in gastos %}
                        <tr>
                            <td>{{ gasto.concepto }}</td>
                            <td>{{ gasto.get_tipo_display }}</td>
                            <td class="text-end">
                                {{ gasto.importe|floatformat:2|intcomma }} €
                            </td>
                            <td>{{ gasto.fecha|date:"d/m/Y" }}</td>
                            <td class="text-end">
                                <a href="#" class="btn btn-sm btn-outline-secondary">
                                    Facturas
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <div class="p-4 text-muted text-center">
                    No hay gastos registrados en este proyecto.
                </div>
            {% endif %}

        </div>
    </div>

</div>

{% endblock %}
{% extends "core/base.html" %}
{% load humanize %}

{% block content %}
<div class="container-fluid">

  <!-- CABECERA -->
  <div class="mb-4">
    <h3 class="fw-semibold mb-1">Datos económicos del proyecto</h3>
    <p class="text-muted mb-0">
      Control y seguimiento del tráfico económico de la operación
    </p>
  </div>

  <form method="post">
    {% csrf_token %}
    <input type="hidden" name="form_tipo" value="datos_economicos">

    <!-- BLOQUE: Precio de escritura -->
    <!-- Este bloque contiene el precio escriturado de adquisición, base de cálculo del proyecto -->
    <div class="card shadow-sm mb-4">
      <div class="card-body">
        <label for="precio_escritura" class="form-label fw-semibold">Precio de escritura</label>
        <div class="input-group">
          <input type="number" step="0.01" class="form-control" id="precio_escritura" name="precio_escritura" value="{{ datos_economicos.precio_escritura }}">
          <span class="input-group-text">€</span>
        </div>
        <div class="form-text">Importe escriturado de adquisición. Base de cálculo del proyecto.</div>
      </div>
    </div>

    <!-- BLOQUE: Resumen económico -->
    <!-- Resumen visual de los gastos totales, ordinarios, extraordinarios e impacto en beneficio -->
    <div class="row g-3 mb-4">
      <div class="col-md-3">
        <div class="card shadow-sm">
          <div class="card-body">
            <div class="small text-muted">Gastos totales</div>
            <div class="fs-5 fw-semibold">{{ total_gastos|floatformat:2|intcomma }} €</div>
          </div>
        </div>
      </div>

      <div class="col-md-3">
        <div class="card shadow-sm">
          <div class="card-body">
            <div class="small text-muted">Gastos ordinarios</div>
            <div class="fs-5 fw-semibold">{{ total_gastos_ordinarios|floatformat:2|intcomma }} €</div>
          </div>
        </div>
      </div>

      <div class="col-md-3">
        <div class="card shadow-sm">
          <div class="card-body">
            <div class="small text-muted">Gastos extraordinarios</div>
            <div class="fs-5 fw-semibold">{{ total_gastos_extraordinarios|floatformat:2|intcomma }} €</div>
          </div>
        </div>
      </div>

      <div class="col-md-3">
        <div class="card shadow-sm border-start border-4 border-warning">
          <div class="card-body">
            <div class="small text-muted">Impacto en beneficio</div>
            <div class="fs-5 fw-semibold">{{ impacto_beneficio|floatformat:2|intcomma }} €</div>
          </div>
        </div>
      </div>
    </div>

    <!-- BLOQUE: Gastos estructurales del proyecto -->
    <!-- Conceptos que siempre forman parte de la operación, divididos en gastos de adquisición y legales, y gastos operativos y de gestión -->
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-light fw-semibold">
        Gastos estructurales del proyecto
      </div>
      <div class="card-body">
        <p class="text-muted small mb-3">
          Conceptos que siempre forman parte de la operación.
        </p>

        <h6 class="fw-semibold">Gastos de adquisición y legales</h6>
        <div class="row g-2 mb-3">
          <div class="col-md-4"><div class="d-flex justify-content-between p-2 border rounded"><span>Notaría</span><input type="number" step="0.01" class="form-control form-control-sm text-end" name="notaria" value="{{ gastos_base.notaria }}"></div></div>
          <div class="col-md-4"><div class="d-flex justify-content-between p-2 border rounded"><span>Impuestos</span><input type="number" step="0.01" class="form-control form-control-sm text-end" name="impuestos" value="{{ gastos_base.impuestos }}"></div></div>
          <div class="col-md-4"><div class="d-flex justify-content-between p-2 border rounded"><span>Registro</span><input type="number" step="0.01" class="form-control form-control-sm text-end" name="registro" value="{{ gastos_base.registro }}"></div></div>
          <div class="col-md-4"><div class="d-flex justify-content-between p-2 border rounded"><span>Gestoría</span><input type="number" step="0.01" class="form-control form-control-sm text-end" name="gestoria" value="{{ gastos_base.gestoria }}"></div></div>
          <div class="col-md-4"><div class="d-flex justify-content-between p-2 border rounded"><span>IBI</span><input type="number" step="0.01" class="form-control form-control-sm text-end" name="ibi" value="{{ gastos_base.ibi }}"></div></div>
        </div>

        <h6 class="fw-semibold">Gastos operativos y de gestión</h6>
        <div class="row g-2">
          <div class="col-md-4"><div class="d-flex justify-content-between p-2 border rounded"><span>Alarma</span><input type="number" step="0.01" class="form-control form-control-sm text-end" name="alarma" value="{{ gastos_base.alarma }}"></div></div>
          <div class="col-md-4"><div class="d-flex justify-content-between p-2 border rounded"><span>Limpieza / Vaciado</span><input type="number" step="0.01" class="form-control form-control-sm text-end" name="limpieza_vaciado" value="{{ gastos_base.limpieza_vaciado }}"></div></div>
          <div class="col-md-4"><div class="d-flex justify-content-between p-2 border rounded"><span>Cerrajero</span><input type="number" step="0.01" class="form-control form-control-sm text-end" name="cerrajero" value="{{ gastos_base.cerrajero }}"></div></div>
          <div class="col-md-4"><div class="d-flex justify-content-between p-2 border rounded"><span>Agua</span><input type="number" step="0.01" class="form-control form-control-sm text-end" name="agua" value="{{ gastos_base.agua }}"></div></div>
          <div class="col-md-4"><div class="d-flex justify-content-between p-2 border rounded"><span>Luz</span><input type="number" step="0.01" class="form-control form-control-sm text-end" name="luz" value="{{ gastos_base.luz }}"></div></div>
          <div class="col-md-4"><div class="d-flex justify-content-between p-2 border rounded"><span>Comunidad</span><input type="number" step="0.01" class="form-control form-control-sm text-end" name="comunidad" value="{{ gastos_base.comunidad }}"></div></div>
          <div class="col-md-4"><div class="d-flex justify-content-between p-2 border rounded"><span>Comercialización</span><input type="number" step="0.01" class="form-control form-control-sm text-end" name="comercializacion" value="{{ gastos_base.comercializacion }}"></div></div>
          <div class="col-md-4"><div class="d-flex justify-content-between p-2 border rounded"><span>Administración</span><input type="number" step="0.01" class="form-control form-control-sm text-end" name="administracion" value="{{ gastos_base.administracion }}"></div></div>
          <div class="col-md-4"><div class="d-flex justify-content-between p-2 border rounded"><span>Comisión Inversure</span><input type="number" step="0.01" class="form-control form-control-sm text-end" name="comision_inversure" value="{{ gastos_base.comision_inversure }}"></div></div>
        </div>
      </div>
    </div>

    <!-- BLOQUE: Gastos extraordinarios -->
    <!-- Gastos extraordinarios registrados en la operación -->
    <div class="card shadow-sm border-start border-4 border-danger">
      <div class="card-header bg-light fw-semibold">
        Gastos extraordinarios
      </div>

      {% if gastos_extraordinarios %}
      <div class="table-responsive">
        <table class="table table-striped mb-0">
          <thead class="table-light">
            <tr>
              <th>Concepto</th>
              <th>Tipo</th>
              <th class="text-end">Importe</th>
              <th>Fecha</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            {% for gasto in gastos_extraordinarios %}
            <tr>
              <td>{{ gasto.concepto }}</td>
              <td>{{ gasto.get_tipo_display }}</td>
              <td class="text-end">{{ gasto.importe|floatformat:2|intcomma }} €</td>
              <td>{{ gasto.fecha|date:"d/m/Y" }}</td>
              <td class="text-end">
                <a href="#" class="btn btn-sm btn-outline-secondary">Facturas</a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
        <div class="p-4 text-center text-muted">No hay gastos extraordinarios registrados.</div>
      {% endif %}
    </div>

    <div class="position-sticky bottom-0 bg-white border-top py-3 d-flex justify-content-end">
      <button type="submit" class="btn btn-primary">Guardar cambios económicos</button>
    </div>
  </form>

</div>
{% endblock %}
{% extends "core/base.html" %}
{% load static humanize %}


{% block content %}


{% csrf_token %}
<form method="POST" id="form-estudio" onsubmit="return false;">
{% if estudio %}
    <input type="hidden" id="estudio_id" name="estudio_id" value="{{ estudio.id }}">
{% endif %}

<div class="main-container simulador-page">
    <div class="container mt-5">

  <!-- CABECERA PRODUCTO -->
  <div class="card card-inversure shadow-sm border-0 mb-4">
    <div class="card-body d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center">
      <div>
        <h1 class="mb-1">Estudio de inversi√≥n</h1>
        {% if estudio and estudio.id %}
          <div class="mt-2">
            <span class="badge bg-light text-dark fw-semibold">
              ESTUDIO ¬∑ EST-{{ estudio.id|stringformat:"06d" }}
            </span>
          </div>
        {% endif %}
        <p class="text-muted mb-0">
          An√°lisis t√©cnico, validaci√≥n de comit√© y resumen inversor en una sola herramienta.
        </p>
      </div>
      <div class="action-panel mt-3 mt-md-0">
        <div class="action-group primary-actions">
          <button type="button" class="btn btn-inversure-secondary" id="btnGuardarEstudio">
            üíæ Guardar estudio
          </button>
          <div class="action-hint text-muted small mt-1">
            Guarda el estudio para conservar cambios y generar el PDF
          </div>
        </div>

        <div class="action-divider my-2"></div>

        <div class="action-group secondary-actions">
          {% if estudio and estudio.id %}
          <button
            type="button"
            class="btn btn-outline-secondary"
            id="btnGenerarPdf"
            data-pdf-url="{% url 'core:pdf_estudio_preview' estudio.id %}">
            üìÑ Generar PDF
          </button>
          {% endif %}
          <a href="{% url 'core:lista_estudio' %}" class="btn btn-link text-decoration-none">
            ‚Üê Volver a estudios
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- IDENTIFICACI√ìN DEL PROYECTO -->
  <div class="card card-inversure shadow-sm border-0 mb-4">
  <div class="card-header bg-inversure-dark text-inversure fw-semibold border-0 d-flex align-items-center gap-2">
    <span class="icon-inversure">üè†</span>
    <span>Datos del inmueble</span>
  </div>
<div class="card-body">
      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label fw-semibold">Nombre del proyecto</label>
          <input type="text" class="form-control" id="nombre_proyecto" name="nombre"
                 value="{{ estudio.nombre|default_if_none:'' }}">
        </div>
        <div class="col-md-5">
          <label class="form-label fw-semibold">Direcci√≥n completa</label>
          <input type="text" class="form-control" id="direccion_completa" name="direccion"
                 value="{{ estudio.direccion|default_if_none:'' }}">
        </div>
        <div class="col-md-3">
          <label class="form-label fw-semibold">Referencia catastral</label>
          <input type="text" class="form-control" id="referencia_catastral" name="ref_catastral"
                 value="{{ estudio.ref_catastral|default_if_none:'' }}">
        </div>
      </div>
      <div class="row g-3 mt-1">
        <div class="col-md-4">
          <label class="form-label fw-semibold">Valor de referencia</label>
          <input type="text" class="form-control currency-input" id="valor_referencia" name="valor_referencia"
                 inputmode="decimal" autocomplete="off"
                 value="{{ estudio.valor_referencia|default_if_none:'' }}">
        </div>
      </div>

      <div class="row g-3 mt-1">
        <div class="col-md-4">
          <label class="form-label fw-semibold">Tipolog√≠a</label>
          <select class="form-select" id="tipologia" name="tipologia">
            <option value="" {% if not estudio.tipologia %}selected{% endif %}>Selecciona‚Ä¶</option>
            <option value="Piso" {% if estudio.tipologia == "Piso" %}selected{% endif %}>Piso</option>
            <option value="√Åtico" {% if estudio.tipologia == "√Åtico" %}selected{% endif %}>√Åtico</option>
            <option value="D√∫plex" {% if estudio.tipologia == "D√∫plex" %}selected{% endif %}>D√∫plex</option>
            <option value="Chalet" {% if estudio.tipologia == "Chalet" %}selected{% endif %}>Chalet</option>
            <option value="Adosado" {% if estudio.tipologia == "Adosado" %}selected{% endif %}>Adosado</option>
            <option value="Unifamiliar" {% if estudio.tipologia == "Unifamiliar" %}selected{% endif %}>Unifamiliar</option>
            <option value="Local" {% if estudio.tipologia == "Local" %}selected{% endif %}>Local</option>
            <option value="Oficina" {% if estudio.tipologia == "Oficina" %}selected{% endif %}>Oficina</option>
            <option value="Solar/Parcela" {% if estudio.tipologia == "Solar/Parcela" %}selected{% endif %}>Solar/Parcela</option>
            <option value="Garaje" {% if estudio.tipologia == "Garaje" %}selected{% endif %}>Garaje</option>
            <option value="Trastero" {% if estudio.tipologia == "Trastero" %}selected{% endif %}>Trastero</option>
            <option value="Otro" {% if estudio.tipologia == "Otro" %}selected{% endif %}>Otro</option>
          </select>
        </div>

        <div class="col-md-4">
          <label class="form-label fw-semibold">Superficie (m¬≤)</label>
          <input type="number" class="form-control" id="superficie_m2" name="superficie_m2"
                 inputmode="decimal" min="0" step="0.01" autocomplete="off"
                 value="{{ estudio.superficie_m2|default_if_none:'' }}">
        </div>

        <div class="col-md-4">
          <label class="form-label fw-semibold">Estado</label>
          <select class="form-select" id="estado" name="estado">
            <option value="" {% if not estudio.estado %}selected{% endif %}>Selecciona‚Ä¶</option>
            <option value="Conservado" {% if estudio.estado == "Conservado" %}selected{% endif %}>Conservado</option>
            <option value="Buen estado" {% if estudio.estado == "Buen estado" %}selected{% endif %}>Buen estado</option>
            <option value="Reformado" {% if estudio.estado == "Reformado" %}selected{% endif %}>Reformado</option>
            <option value="A reformar" {% if estudio.estado == "A reformar" %}selected{% endif %}>A reformar</option>
          </select>
        </div>
      </div>

      <div class="row g-3 mt-1">
        <div class="col-md-4">
          <label class="form-label fw-semibold">Situaci√≥n</label>
          <select class="form-select" id="situacion" name="situacion">
            <option value="" {% if not estudio.situacion %}selected{% endif %}>Selecciona‚Ä¶</option>
            <option value="Libre" {% if estudio.situacion == "Libre" %}selected{% endif %}>Libre</option>
            <option value="Ocupado" {% if estudio.situacion == "Ocupado" %}selected{% endif %}>Ocupado</option>
            <option value="Alquilado" {% if estudio.situacion == "Alquilado" %}selected{% endif %}>Alquilado</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  <!-- TABS -->
  <ul class="nav nav-tabs mb-4" id="simuladorTabs" role="tablist">
    <li class="nav-item">
      <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#vista-tecnica" type="button">
        Vista t√©cnica
      </button>
    </li>
    <li class="nav-item">
      <button class="nav-link" data-bs-toggle="tab" data-bs-target="#vista-comite" type="button">
        Vista comit√©
      </button>
    </li>
    <li class="nav-item">
      <button class="nav-link" data-bs-toggle="tab" data-bs-target="#vista-inversor" type="button">
        Vista inversor
      </button>
    </li>
  </ul>

  <div class="tab-content">

    <!-- VISTA TECNICA -->
    <div class="tab-pane fade show active" id="vista-tecnica">

      <div class="card card-inversure shadow-sm border-0 mb-4 inversure-section">
        <div class="card-header bg-inversure-dark text-inversure fw-semibold border-0 d-flex align-items-center gap-2">
          <span class="icon-inversure">üí∂</span>
          <span>Datos de adquisici√≥n</span>
        </div>
        <div class="card-body">

          <div class="row g-3 mb-3">
            <div class="col-md-6">
              <label class="form-label">Precio de escritura</label>
              <input type="text" class="form-control currency-input" id="precio_escritura" name="precio_escritura" inputmode="decimal" autocomplete="off" value="{{ estudio.precio_escritura|default_if_none:'' }}">
            </div>
            <div class="col-md-6">
              <label class="form-label">ITP (2 %)</label>
              <input type="text" class="form-control currency-input" id="itp" name="itp" inputmode="decimal" autocomplete="off" readonly value="{{ estudio.itp|default_if_none:'' }}">
            </div>
          </div>

          <div class="row g-3 mb-3">
            <div class="col-md-6">
              <label class="form-label">Notar√≠a</label>
              <input type="text" class="form-control currency-input" id="notaria" name="notaria" inputmode="decimal" autocomplete="off" value="{{ estudio.notaria|default_if_none:'' }}">
            </div>
            <div class="col-md-6">
              <label class="form-label">Registro</label>
              <input type="text" class="form-control currency-input" id="registro" name="registro" inputmode="decimal" autocomplete="off" value="{{ estudio.registro|default_if_none:'' }}">
            </div>
          </div>

          <div class="row g-3 mb-3">
            <div class="col-md-6">
              <label class="form-label">Gastos extras</label>
              <input type="text" class="form-control currency-input" id="gastos_extras" name="gastos_extras" inputmode="decimal" autocomplete="off" value="{{ estudio.gastos_extras|default_if_none:'' }}">
            </div>
          </div>

          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label fw-bold">Valor de adquisici√≥n</label>
              <input type="text" class="form-control currency-input input-result" id="valor_adquisicion" name="valor_adquisicion" inputmode="decimal" autocomplete="off" readonly value="{{ estudio.valor_adquisicion|default_if_none:'' }}">
            </div>
            <div class="col-md-6">
              <label class="form-label fw-bold">Valor de transmisi√≥n</label>
              <input type="text" class="form-control currency-input input-result" id="valor_transmision" name="valor_transmision" inputmode="decimal" autocomplete="off" readonly value="{{ estudio.valor_transmision|default_if_none:'' }}">
            </div>
          </div>

        </div>
      </div>

      <div class="card card-inversure shadow-sm border-0 mb-4 inversure-section">
        <div class="card-header bg-inversure-dark text-inversure fw-semibold border-0 d-flex align-items-center gap-2">
          <span class="icon-inversure">üìà</span>
          <span>Valoraciones de mercado</span>
        </div>
        <div class="card-body">

          <div class="row g-3 mb-3">
            <div class="col-md-4">
              <label class="form-label">Tasaci√≥n</label>
              <input type="text" class="form-control valoracion currency-input" name="valoracion_tasacion" inputmode="decimal" autocomplete="off" value="{{ estudio.valoracion_tasacion|default_if_none:'' }}">
            </div>
            <div class="col-md-4">
              <label class="form-label">Idealista</label>
              <input type="text" class="form-control valoracion currency-input" name="valoracion_idealista" inputmode="decimal" autocomplete="off" value="{{ estudio.valoracion_idealista|default_if_none:'' }}">
            </div>
            <div class="col-md-4">
              <label class="form-label">Fotocasa</label>
              <input type="text" class="form-control valoracion currency-input" name="valoracion_fotocasa" inputmode="decimal" autocomplete="off" value="{{ estudio.valoracion_fotocasa|default_if_none:'' }}">
            </div>
          </div>

          <div class="row g-3 mb-3">
            <div class="col-md-6">
              <label class="form-label">Registradores</label>
              <input type="text" class="form-control valoracion currency-input" name="valoracion_registradores" inputmode="decimal" autocomplete="off" value="{{ estudio.valoracion_registradores|default_if_none:'' }}">
            </div>
            <div class="col-md-6">
              <label class="form-label">Casafari</label>
              <input type="text" class="form-control valoracion currency-input" name="valoracion_casafari" inputmode="decimal" autocomplete="off" value="{{ estudio.valoracion_casafari|default_if_none:'' }}">
            </div>
          </div>

          <div class="row">
            <div class="col-md-6">
              <label class="form-label fw-bold">Media de valoraciones</label>
              <input type="text" class="form-control currency-input input-result" id="media_valoraciones" name="media_valoraciones" inputmode="decimal" autocomplete="off" readonly value="{{ estudio.media_valoraciones|default_if_none:'' }}">
            </div>
          </div>

        </div>
      </div>

    </div>

    <!-- VISTA COMITE -->
    <div class="tab-pane fade" id="vista-comite">
      <div class="row g-4">

        <!-- BLOQUE 1 ¬∑ DECISI√ìN COMIT√â -->
        <div class="col-12">
          <div class="card shadow-sm border-0 mb-3">
            <div class="card-header fw-bold">Decisi√≥n del comit√©</div>
            <div class="card-body">
              <div class="row g-4">

                <div class="col-md-3">
                  <div class="card kpi-card kpi-beneficio text-center shadow-sm">
                    <div class="card-body">
                      <h6 class="text-muted">Beneficio bruto</h6>
                      <p class="fs-3 fw-bold kpi-dinamico" id="kpi_beneficio_bruto">--</p>
                    </div>
                  </div>
                </div>

                <div class="col-md-3">
                  <div class="card kpi-card kpi-roi text-center shadow-sm">
                    <div class="card-body">
                      <h6 class="text-muted">ROI</h6>
                      <p class="fs-3 fw-bold kpi-dinamico" id="kpi_roi">--</p>
                    </div>
                  </div>
                </div>

                <div class="col-md-3">
                  <div class="card kpi-card kpi-riesgo text-center shadow-sm">
                    <div class="card-body">
                      <h6 class="text-muted">Nivel de riesgo</h6>
                      <p class="fs-3 fw-bold" id="kpi_nivel_riesgo">--</p>
                      <div class="d-flex justify-content-center gap-2 mt-2">
                        <span class="semaforo-dot" id="riesgo_bajo"></span>
                        <span class="semaforo-dot" id="riesgo_medio"></span>
                        <span class="semaforo-dot" id="riesgo_alto"></span>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="col-md-3">
                  <div class="card kpi-card kpi-decision text-center shadow-sm">
                    <div class="card-body">
                      <h6 class="text-muted">Decisi√≥n</h6>
                      <p class="fs-3 fw-bold kpi-semaforo" id="kpi_semaforo">--</p>
                    </div>
                  </div>
                </div>

              </div>
            </div>
          </div>
        </div>

        <!-- BLOQUE ¬∑ RESUMEN EJECUTIVO DEL COMIT√â -->
        <div class="col-12">
          <div class="card shadow-sm border-0 mb-3">
            <div class="card-header fw-bold">
              Resumen ejecutivo del comit√©
            </div>
            <div class="card-body">
              <p class="text-muted small mb-2">
                S√≠ntesis final para informes, PDF y presentaci√≥n a socios.
              </p>

              <textarea
                class="form-control"
                id="resumen_ejecutivo_comite"
                name="resumen_ejecutivo_comite"
                rows="3"
                maxlength="600"
                placeholder="Ejemplo: Operaci√≥n con ROI atractivo, margen suficiente y riesgo controlado. El comit√© recomienda su aprobaci√≥n."></textarea>

              <div class="form-text text-muted mt-1">
                Este texto se usar√° directamente en el PDF del estudio.
              </div>
            </div>
          </div>
        </div>

        <!-- BLOQUE ¬∑ VALORACI√ìN DEL COMIT√â -->
        <div class="col-12">
          <div class="card shadow-sm border-0 mb-3">
            <div class="card-header fw-bold">
              Valoraci√≥n del comit√©
            </div>
            <div class="card-body">
              <div class="row g-3">

                <div class="col-md-3">
                  <label class="form-label fw-semibold">Mercado</label>
                  <select class="form-select" id="valoracion_mercado" name="valoracion_mercado">
                    <option value="">Selecciona‚Ä¶</option>
                    <option value="muy_favorable">Muy favorable</option>
                    <option value="favorable">Favorable</option>
                    <option value="neutral">Neutral</option>
                    <option value="desfavorable">Desfavorable</option>
                  </select>
                </div>

                <div class="col-md-3">
                  <label class="form-label fw-semibold">Riesgo</label>
                  <select class="form-select" id="valoracion_riesgo" name="valoracion_riesgo">
                    <option value="">Selecciona‚Ä¶</option>
                    <option value="bajo">Bajo</option>
                    <option value="medio">Medio</option>
                    <option value="alto">Alto</option>
                  </select>
                </div>

                <div class="col-md-3">
                  <label class="form-label fw-semibold">Ejecuci√≥n</label>
                  <select class="form-select" id="valoracion_ejecucion" name="valoracion_ejecucion">
                    <option value="">Selecciona‚Ä¶</option>
                    <option value="sencilla">Sencilla</option>
                    <option value="media">Media</option>
                    <option value="compleja">Compleja</option>
                  </select>
                </div>

                <div class="col-md-3">
                  <label class="form-label fw-semibold">Timing</label>
                  <select class="form-select" id="valoracion_timing" name="valoracion_timing">
                    <option value="">Selecciona‚Ä¶</option>
                    <option value="optimo">√ìptimo</option>
                    <option value="adecuado">Adecuado</option>
                    <option value="dudoso">Dudoso</option>
                  </select>
                </div>

                <div class="col-12 mt-2">
                  <label class="form-label fw-semibold">Comentario del comit√© (opcional)</label>
                  <textarea
                    class="form-control"
                    id="comentario_comite"
                    name="comentario_comite"
                    rows="2"
                    maxlength="300"
                    placeholder="Breve justificaci√≥n de la valoraci√≥n del comit√©‚Ä¶"></textarea>
                </div>

              </div>
            </div>
          </div>
        </div>

        <!-- BLOQUE ¬∑ DECISI√ìN FORMAL DEL COMIT√â -->
        <div class="col-12">
          <div class="card shadow-sm border-0">
            <div class="card-header fw-bold">
              Decisi√≥n formal del comit√©
            </div>
            <div class="card-body">
              <div class="row align-items-end g-3">

                <div class="col-md-4">
                  <label class="form-label fw-semibold">Estado del estudio</label>
                  <select class="form-select" id="decision_comite" name="decision_comite" required>
                    <option value="">Selecciona‚Ä¶</option>
                    <option value="aprobada">üü¢ Aprobada</option>
                    <option value="estudio">üü† En estudio</option>
                    <option value="denegada">üî¥ Denegada</option>
                  </select>
                </div>

                <div class="col-md-4">
                  <label class="form-label fw-semibold">Fecha de decisi√≥n</label>
                  <input
                    type="text"
                    class="form-control"
                    id="fecha_decision_comite"
                    name="fecha_decision_comite"
                    readonly
                    placeholder="Pendiente de decisi√≥n">
                </div>

                <div class="col-md-4 text-muted small">
                  Esta decisi√≥n determina si el estudio puede convertirse en proyecto
                  y si se presenta a inversores.
                </div>

              </div>
            </div>
          </div>
        </div>

        <!-- BLOQUE 2 ¬∑ ROBUSTEZ -->
        <div class="col-12">
          <div class="card shadow-sm border-0 mb-3">
            <div class="card-header fw-bold">Robustez de la operaci√≥n</div>
            <div class="card-body">
              <div class="row g-4">

                <div class="col-md-3">
                  <div class="card text-center shadow-sm">
                    <div class="card-body">
                      <h6 class="text-muted">Margen</h6>
                      <p class="fs-4 fw-bold" id="kpi_margen">--</p>
                    </div>
                  </div>
                </div>

                <div class="col-md-3">
                  <div class="card text-center shadow-sm">
                    <div class="card-body">
                      <h6 class="text-muted">Ratio ‚Ç¨ / beneficio</h6>
                      <p class="fs-4 fw-bold" id="kpi_ratio_beneficio">--</p>
                    </div>
                  </div>
                </div>

                <div class="col-md-3">
                  <div class="card text-center shadow-sm">
                    <div class="card-body">
                      <h6 class="text-muted">Colch√≥n de seguridad</h6>
                      <p class="fs-4 fw-bold" id="kpi_colchon_seguridad">--</p>
                    </div>
                  </div>
                </div>

                <div class="col-md-3">
                  <div class="card text-center shadow-sm">
                    <div class="card-body">
                      <h6 class="text-muted">Breakeven</h6>
                      <p class="fs-4 fw-bold" id="kpi_breakeven">--</p>
                    </div>
                  </div>
                </div>

              </div>
            </div>
          </div>
        </div>

        <!-- BLOQUE 3 ¬∑ CONTROL -->
        <div class="col-12">
          <div class="card shadow-sm border-0">
            <div class="card-header fw-bold">Control econ√≥mico</div>
            <div class="card-body">
              <div class="row g-4">

                <div class="col-md-6">
                  <div class="card text-center shadow-sm">
                    <div class="card-body">
                      <h6 class="text-muted">Valor de adquisici√≥n</h6>
                      <p class="fs-5 fw-bold" id="kpi_valor_adquisicion">--</p>
                    </div>
                  </div>
                </div>

                <div class="col-md-6">
                  <div class="card text-center shadow-sm">
                    <div class="card-body">
                      <h6 class="text-muted">Valor de transmisi√≥n</h6>
                      <p class="fs-5 fw-bold" id="kpi_valor_transmision">--</p>
                    </div>
                  </div>
                </div>

              </div>
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- VISTA INVERSOR (RESET LIMPIO) -->
    <div class="tab-pane fade" id="vista-inversor">
      <div class="row g-4">


        <!-- CONDICIONES COMERCIALES ¬∑ COMISI√ìN INVERSURE -->
        <div class="col-12">
          <div class="card shadow-sm border-0 mb-3">
            <div class="card-header fw-bold">
              Condiciones del acuerdo
            </div>
            <div class="card-body">
              <div class="row align-items-center g-3">

                <div class="col-md-4">
                  <label class="form-label fw-semibold">
                    Comisi√≥n Inversure sobre beneficio
                  </label>
                  <select id="inv_porcentaje_comision" class="form-select">
                    <option value="30">30 %</option>
                    <option value="35">35 %</option>
                    <option value="40">40 %</option>
                  </select>
                </div>
<div class="col-md-8">
  <div class="text-muted small">
    La comisi√≥n se descuenta del beneficio bruto antes del reparto al inversor.
  </div>
  <div class="mt-2 fw-semibold">
    Comisi√≥n estimada: <span id="inversor_comision_eur">--</span>
  </div>
</div>

              </div>
            </div>
          </div>
        </div>

        <div class="col-12">
          <div class="card shadow-sm border-0">
            <div class="card-header fw-bold">
              Indicadores clave para el inversor
            </div>
            <div class="card-body">
              <div class="row g-4">

                <div class="col-md-4">
                  <div class="card text-center shadow-sm">
                    <div class="card-body">
                      <h6 class="text-muted">Inversi√≥n total</h6>
                      <p class="fs-4 fw-bold" id="inversor_inversion">--</p>
                    </div>
                  </div>
                </div>

                <div class="col-md-4">
                  <div class="card text-center shadow-sm">
                    <div class="card-body">
                      <h6 class="text-muted">Beneficio neto</h6>
                      <p class="fs-4 fw-bold text-success" id="inversor_beneficio_neto">--</p>
                    </div>
                  </div>
                </div>

                <div class="col-md-4">
                  <div class="card text-center shadow-sm">
                    <div class="card-body">
                      <h6 class="text-muted">ROI neto</h6>
                      <p class="fs-4 fw-bold" id="inversor_roi_neto">--</p>
                    </div>
                  </div>
                </div>

              </div>
            </div>
          </div>
        </div>

      </div>
    </div>

  </div>

  </div>
</div>

<script>
  // Datos iniciales del estudio (hidrataci√≥n desde servidor)
  window.ESTUDIO_ID = "{% if estudio %}{{ estudio.id }}{% endif %}";
  window.ESTADO_INICIAL = {{ ESTADO_INICIAL_JSON|default:"{}"|safe }};

  // Fallback de hidrataci√≥n: si abrimos un estudio guardado y el template no tiene campos mapeados,
  // rellenamos inputs desde ESTADO_INICIAL antes de que corran los c√°lculos.
  (function () {
    function setIfEmpty(el, value) {
      if (!el) return;
      const v = (value === null || value === undefined) ? "" : String(value);
      if ((el.value || "").trim() === "" && v.trim() !== "") {
        el.value = v;
      }
    }

    function setSelectIfEmpty(el, value) {
      if (!el) return;
      const v = (value === null || value === undefined) ? "" : String(value);
      if ((el.value || "").trim() === "" && v.trim() !== "") {
        el.value = v;
      }
    }

    function setByNameIfEmpty(name, value) {
      const el = document.querySelector(`[name="${name}"]`);
      setIfEmpty(el, value);
    }

    document.addEventListener('DOMContentLoaded', function () {
      const s = window.ESTADO_INICIAL || {};
      if (!s || typeof s !== 'object' || Object.keys(s).length === 0) return;

      // Si viene encapsulado en snapshot/inmueble/economico/inversor, lo aplanamos lo justo
      const inmueble = s.inmueble || s.texto || {};
      const kpis = s.kpis || {};
      const metricas = (kpis.metricas || {});
      const comite = s.comite || {};
      const economico = s.economico || {};

      // Identificaci√≥n inmueble
      setIfEmpty(document.getElementById('nombre_proyecto'), inmueble.nombre_proyecto || s.nombre_proyecto);
      setIfEmpty(document.getElementById('direccion_completa'), inmueble.direccion || s.direccion);
      setIfEmpty(document.getElementById('referencia_catastral'), inmueble.ref_catastral || s.ref_catastral);
      setIfEmpty(document.getElementById('valor_referencia'), inmueble.valor_referencia || metricas.valor_referencia);

      setSelectIfEmpty(document.getElementById('tipologia'), inmueble.tipologia || s.tipologia);
      setIfEmpty(document.getElementById('superficie_m2'), inmueble.superficie_m2 || metricas.superficie_m2);
      setSelectIfEmpty(document.getElementById('estado'), inmueble.estado || s.estado);
      setSelectIfEmpty(document.getElementById('situacion'), inmueble.situacion || s.situacion);

      // Adquisici√≥n / gastos
      setIfEmpty(document.getElementById('precio_escritura'), metricas.precio_escritura || s.precio_escritura);
      setIfEmpty(document.getElementById('notaria'), metricas.notaria || s.notaria);
      setIfEmpty(document.getElementById('registro'), metricas.registro || s.registro);
      setIfEmpty(document.getElementById('gastos_extras'), metricas.gastos_extras || s.gastos_extras);

      // Valoraciones
      setByNameIfEmpty('valoracion_tasacion', (s.valoraciones && s.valoraciones.tasacion) || s.valoracion_tasacion);
      setByNameIfEmpty('valoracion_idealista', (s.valoraciones && s.valoraciones.idealista) || s.valoracion_idealista);
      setByNameIfEmpty('valoracion_fotocasa', (s.valoraciones && s.valoraciones.fotocasa) || s.valoracion_fotocasa);
      setByNameIfEmpty('valoracion_registradores', (s.valoraciones && s.valoraciones.registradores) || s.valoracion_registradores);
      setByNameIfEmpty('valoracion_casafari', (s.valoraciones && s.valoraciones.casafari) || s.valoracion_casafari);

      // Comit√© (campos de texto/selecci√≥n)
      setIfEmpty(document.getElementById('resumen_ejecutivo_comite'), comite.observaciones || s.resumen_ejecutivo_comite);
      setSelectIfEmpty(document.getElementById('decision_comite'), comite.decision || s.decision_comite);
      setIfEmpty(document.getElementById('comentario_comite'), comite.comentario || s.comentario_comite);

      // Comisi√≥n inversor
      setSelectIfEmpty(document.getElementById('inv_porcentaje_comision'), (s.inversor && s.inversor.comision_pct) || s.comision_pct || s.comision_inversure_pct);

      // Disparar recalculo si existe funci√≥n global
      try {
        if (typeof window.recalcularTodo === 'function') window.recalcularTodo();
      } catch (e) {}
    });
  })();
</script>
<script src="{% static 'core/simulador.js' %}"></script>
</div>
</div>
</form>
<script>
(function () {
  const btn = document.getElementById('btnGenerarPdf');
  if (!btn) return;

  btn.addEventListener('click', function () {
    const url = btn.dataset.pdfUrl;
    if (url) {
      window.location.href = url;
    }
  });
})();
</script>
<script>
(function () {
  // --- Utilidades seguras ---
  function parseNumber(v) {
    if (v === null || v === undefined) return 0;
    const s = String(v)
      .replace(/\u00a0/g, ' ')
      .replace(/[^0-9,.-]/g, '')
      .trim();
    if (!s) return 0;
    // Formato ES: 1.234,56
    const normalized = s.indexOf(',') >= 0
      ? s.replace(/\./g, '').replace(',', '.')
      : s;
    const n = parseFloat(normalized);
    return Number.isFinite(n) ? n : 0;
  }

  const nfCur = new Intl.NumberFormat('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  const nfPct = new Intl.NumberFormat('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

  function fmtEur(n) {
    return nfCur.format(Number.isFinite(n) ? n : 0) + ' ‚Ç¨';
  }
  function fmtPct(n) {
    return nfPct.format(Number.isFinite(n) ? n : 0) + ' %';
  }

  // --- Inputs clave ---
  const elPrecioEscritura = document.getElementById('precio_escritura');
  const elItp = document.getElementById('itp');
  const elNotaria = document.getElementById('notaria');
  const elRegistro = document.getElementById('registro');
  const elExtras = document.getElementById('gastos_extras');

  const elValorAdq = document.getElementById('valor_adquisicion');
  const elValorTrans = document.getElementById('valor_transmision');
  const elMediaVal = document.getElementById('media_valoraciones');

  const valoracionInputs = Array.from(document.querySelectorAll('input.valoracion'));

  // KPIs (si existen)
  const kpiBeneficio = document.getElementById('kpi_beneficio_bruto');
  const kpiRoi = document.getElementById('kpi_roi');
  const kpiMargen = document.getElementById('kpi_margen');
  const kpiRatio = document.getElementById('kpi_ratio_beneficio');
  const kpiColchon = document.getElementById('kpi_colchon_seguridad');
  const kpiBreakeven = document.getElementById('kpi_breakeven');

  function recalc() {
    // Adquisici√≥n
    const precio = parseNumber(elPrecioEscritura?.value);
    const notaria = parseNumber(elNotaria?.value);
    const registro = parseNumber(elRegistro?.value);
    const extras = parseNumber(elExtras?.value);

    const itp = precio * 0.02;
    const valorAdq = precio + itp + notaria + registro + extras;

    if (elItp) elItp.value = fmtEur(itp);
    if (elValorAdq) elValorAdq.value = fmtEur(valorAdq);

    // Media valoraciones
    const vals = valoracionInputs
      .map(i => parseNumber(i.value))
      .filter(n => Number.isFinite(n) && n > 0);
    const media = vals.length ? (vals.reduce((a, b) => a + b, 0) / vals.length) : 0;
    if (elMediaVal) elMediaVal.value = fmtEur(media);

    // Transmisi√≥n (por defecto = media de valoraciones)
    const valorTrans = media;
    if (elValorTrans) elValorTrans.value = fmtEur(valorTrans);

    // KPIs
    const beneficio = valorTrans - valorAdq;
    const roi = valorAdq > 0 ? (beneficio / valorAdq) * 100 : 0;
    const margen = valorTrans > 0 ? (beneficio / valorTrans) * 100 : 0;
    const ratio = beneficio !== 0 ? (valorAdq / beneficio) : 0;
    const colchon = media > 0 ? ((media - valorAdq) / media) * 100 : 0;

    if (kpiBeneficio) kpiBeneficio.textContent = fmtEur(beneficio);
    if (kpiRoi) kpiRoi.textContent = fmtPct(roi);
    if (kpiMargen) kpiMargen.textContent = fmtPct(margen);
    if (kpiRatio) kpiRatio.textContent = nfCur.format(ratio);
    if (kpiColchon) kpiColchon.textContent = fmtPct(colchon);
    if (kpiBreakeven) kpiBreakeven.textContent = fmtEur(valorAdq);
  }

  // Listeners (sin pisar otros handlers)
  const watch = [elPrecioEscritura, elNotaria, elRegistro, elExtras, ...valoracionInputs].filter(Boolean);
  watch.forEach(el => {
    el.addEventListener('input', recalc);
    el.addEventListener('change', recalc);
  });

  // Inicial
  recalc();
})();
</script>
{% endblock %}
{% extends "core/base.html" %}
{% load static %}
{% block content %}

<div class="container mt-4">
    <h1 class="mb-1">Simulador de operaciones</h1>
    <p class="text-muted mb-4">
        Introduce los datos para calcular rentabilidad y m√©tricas clave.
    </p>


<form method="post">
{% csrf_token %}


    <!-- ===============================
         DATOS DEL INMUEBLE
    ================================ -->
    <div class="card mb-4 shadow-sm border-0">
        <div class="card-body">
            <h5 class="mb-3 d-flex align-items-center gap-2">
                <span>üìç</span>
                <span>Datos del inmueble</span>
            </h5>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label text-muted">
                        Nombre del proyecto (identificador)
                    </label>
                    <input type="text" name="nombre" class="form-control form-control-lg"
                           value="{{ proyecto.nombre|default:'' }}">
                </div>

                <div class="col-md-6 mb-3">
                    <label class="form-label text-muted">
                        Estado del proyecto
                    </label>
                    <select name="estado" class="form-select form-select-lg">
                        <option value="ESTUDIO"
                            {% if proyecto.estado == "ESTUDIO" or not proyecto.estado %}selected{% endif %}>
                            En estudio
                        </option>
                        <option value="APROBADO"
                            {% if proyecto.estado == "APROBADO" %}selected{% endif %}>
                            Aprobado
                        </option>
                        <option value="DESCARTADO"
                            {% if proyecto.estado == "DESCARTADO" %}selected{% endif %}>
                            Descartado
                        </option>
                    </select>
                </div>

                <div class="col-md-6 mb-3">
                    <label class="form-label">Fecha</label>
                    <input type="date" name="fecha" class="form-control form-control-lg"
                           value="{{ proyecto.fecha|date:'Y-m-d'|default:'' }}">
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">
                      Precio compra inmueble
                      <span class="ms-1 text-muted" title="Calculado autom√°ticamente en base a los datos introducidos">‚ÑπÔ∏è</span>
                    </label>
                    <input type="text" name="precio_compra_inmueble" class="form-control form-control-lg"
                           readonly title="Calculado autom√°ticamente en base a los datos introducidos"
                           value="{{ proyecto.precio_compra_inmueble|default:'' }}">
                </div>

                <div class="col-md-6 mb-3">
                    <label class="form-label">Precio estimado de venta</label>
                    <input type="text" name="precio_venta_estimado" class="form-control form-control-lg"
                           data-euro="true" data-autofill="true"
                           value="{{ proyecto.precio_venta_estimado|default:'' }}">
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3 d-flex gap-2">
                    <div class="flex-grow-1">
                        <label class="form-label">Referencia catastral</label>
                        <input type="text" name="ref_catastral" class="form-control form-control-lg">
                    </div>
                    <div class="align-self-end">
                        <button type="button"
                                id="btnCatastro"
                                class="btn btn-sm px-2 d-flex align-items-center"
                                style="background-color:#122135; color:white;"
                                onclick="verCatastro()"
                                title="Abrir Catastro">
                            <img src="{% static 'core/catastro.png' %}"
                                 alt="Catastro"
                                 style="height:18px; width:auto; filter:brightness(0) invert(1);">
                        </button>
                    </div>
                </div>

                <div class="col-md-6 mb-3">
                    <label class="form-label">Valor de referencia catastral</label>
                    <input type="number" step="0.01" name="valor_referencia" class="form-control">
                </div>
            </div>
        </div>
    </div>

    <!-- ===============================
         DATOS PRINCIPALES
    ================================ -->
    <div class="card mb-4 shadow-sm border-0">
        <div class="card-body">
            <h5 class="mb-3">
                <span class="badge rounded-pill bg-secondary me-2 px-3 py-2">1</span>
                Datos principales
            </h5>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Precio de escritura</label>
                    <input type="text" name="precio_propiedad" class="form-control form-control-lg"
                           value="{{ proyecto.precio_propiedad|default:'' }}">
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Meses de la operaci√≥n</label>
                    <input type="number" name="meses" class="form-control">
                </div>

                <div class="col-md-6 mb-3">
                    <label class="form-label">% Financiaci√≥n</label>
                    <input type="number" step="0.01" name="financiacion_pct" class="form-control">
                </div>
            </div>
        </div>
    </div>

    <!-- ===============================
         GASTOS DE ADQUISICI√ìN
    ================================ -->
    <div class="card mb-4 shadow-sm border-0">
        <div class="card-body">
            <h5 class="mb-3">
                <span class="badge rounded-pill bg-secondary me-2 px-3 py-2">2</span>
                Gastos de adquisici√≥n
            </h5>

            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label">
                      Notar√≠a
                      <span class="ms-1 text-muted" title="Calculado autom√°ticamente en base a los datos introducidos">‚ÑπÔ∏è</span>
                    </label>
                    <input type="text" name="notaria" class="form-control form-control-lg" data-euro="true" readonly title="Calculado autom√°ticamente en base a los datos introducidos"
                           value="{{ proyecto.notaria|default:'' }}">
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">
                      Registro
                      <span class="ms-1 text-muted" title="Calculado autom√°ticamente en base a los datos introducidos">‚ÑπÔ∏è</span>
                    </label>
                    <input type="text" name="registro" class="form-control form-control-lg" data-euro="true" readonly title="Calculado autom√°ticamente en base a los datos introducidos"
                           value="{{ proyecto.registro|default:'' }}">
                </div>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">
                      ITP
                      <span class="ms-1 text-muted" title="Calculado autom√°ticamente en base a los datos introducidos">‚ÑπÔ∏è</span>
                    </label>
                    <input type="text" name="itp" class="form-control form-control-lg" data-euro="true" readonly title="Calculado autom√°ticamente en base a los datos introducidos"
                           value="{{ proyecto.itp|default:'' }}">
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Otros gastos</label>
                    <input type="text" name="otros_gastos_compra" class="form-control" data-euro="true"
                           value="{{ proyecto.otros_gastos_compra|default:'' }}">
                </div>
            </div>
        </div>
    </div>

    <!-- ===============================
         INVERSI√ìN INICIAL
    ================================ -->
    <div class="card mb-4 shadow-sm border-0">
        <div class="card-body">
            <h5 class="mb-3">
                <span class="badge rounded-pill bg-secondary me-2 px-3 py-2">4</span>
                Inversi√≥n inicial
            </h5>

            <div class="row">
                <div class="col-md-3 mb-3">
                    <label class="form-label">Reforma</label>
                    <input type="text" name="reforma" class="form-control form-control-lg" data-euro="true">
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Limpieza inicial</label>
                    <input type="text" name="limpieza_inicial" class="form-control form-control-lg" data-euro="true">
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Mobiliario</label>
                    <input type="text" name="mobiliario" class="form-control form-control-lg" data-euro="true">
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Otros puesta en marcha</label>
                    <input type="text" name="otros_puesta_marcha" class="form-control form-control-lg" data-euro="true">
                </div>
            </div>
        </div>
    </div>

    <!-- ===============================
         GASTOS RECURRENTES
    ================================ -->
    <div class="card mb-4 shadow-sm border-0">
        <div class="card-body">
            <h5 class="mb-3">
                <span class="badge rounded-pill bg-secondary me-2 px-3 py-2">5</span>
                Gastos recurrentes
            </h5>

            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label">Comunidad</label>
                    <input type="text" name="comunidad" class="form-control" data-euro="true">
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">IBI</label>
                    <input type="text" name="ibi" class="form-control" data-euro="true">
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Seguros</label>
                    <input type="text" name="seguros" class="form-control" data-euro="true">
                </div>
            </div>

            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label">Suministros</label>
                    <input type="text" name="suministros" class="form-control" data-euro="true">
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Limpieza peri√≥dica</label>
                    <input type="text" name="limpieza_periodica" class="form-control" data-euro="true">
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Ocupas</label>
                    <input type="text" name="ocupas" class="form-control" data-euro="true">
                </div>
            </div>
        </div>
    </div>

    <!-- ===============================
         GASTOS DE VENTA
    ================================ -->
    <div class="card mb-4 shadow-sm border-0">
        <div class="card-body">
            <h5 class="mb-3">
                <span class="badge rounded-pill bg-secondary me-2 px-3 py-2">6</span>
                Gastos de venta
            </h5>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Plusval√≠a</label>
                    <input type="text" name="plusvalia" class="form-control" data-euro="true">
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Inmobiliaria</label>
                    <input type="text" name="inmobiliaria" class="form-control" data-euro="true">
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Gesti√≥n comercial</label>
                    <input type="text" name="gestion_comercial" class="form-control" data-euro="true">
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Gesti√≥n administraci√≥n</label>
                    <input type="text" name="gestion_administracion" class="form-control" data-euro="true">
                </div>
            </div>
        </div>
    </div>

    <!-- ===============================
         VALORACIONES
    ================================ -->
    <div class="card mb-4 shadow-sm border-0">
        <div class="card-body">
            <h5 class="mb-3">
                <span class="badge rounded-pill bg-secondary me-2 px-3 py-2">7</span>
                Valoraciones
            </h5>

            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label">Idealista</label>
                    <input type="text" name="val_idealista" class="form-control" data-euro="true" data-valuation="true"
                           value="{{ proyecto.val_idealista|default:'' }}">
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Fotocasa</label>
                    <input type="text" name="val_fotocasa" class="form-control" data-euro="true" data-valuation="true"
                           value="{{ proyecto.val_fotocasa|default:'' }}">
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Registradores</label>
                    <input type="text" name="val_registradores" class="form-control" data-euro="true" data-valuation="true"
                           value="{{ proyecto.val_registradores|default:'' }}">
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Casafari</label>
                    <input type="text" name="val_casafari" class="form-control" data-euro="true" data-valuation="true"
                           value="{{ proyecto.val_casafari|default:'' }}">
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Tasaci√≥n</label>
                    <input type="text" name="val_tasacion" class="form-control" data-euro="true" data-valuation="true"
                           value="{{ proyecto.val_tasacion|default:'' }}">
                </div>
            </div>

            <div class="row mt-3">
                <div class="col-md-12">
                    <label class="form-label fw-semibold">
                      Media de valoraciones
                      <span class="ms-1 text-muted" title="Calculado autom√°ticamente en base a los datos introducidos">‚ÑπÔ∏è</span>
                    </label>
                    <input type="text" name="media_valoraciones" class="form-control form-control-lg" readonly title="Calculado autom√°ticamente en base a los datos introducidos"
                           value="{{ proyecto.media_valoraciones|default:'' }}">
                </div>
            </div>
        </div>
    </div>

    <!-- ===============================
         ACCIONES
    ================================ -->
    <div class="d-flex justify-content-end mb-4">
        <button type="submit" class="btn btn-dark">Calcular</button>
    </div>

    <!-- ===============================
         RESULTADOS
    ================================ -->
{% if resultado %}
<div class="card mb-4 shadow-sm border-0 resultado-inversor {% if resultado.viable %}resultado-viable{% else %}resultado-no-viable{% endif %}">
        <div class="card-body">
            <h5 class="mb-3">
                <span class="badge rounded-pill bg-secondary me-2 px-3 py-2">8</span>
                Resultado
            </h5>

            <div class="row">
                <div class="col-md-4">
                    <strong>Valor de adquisici√≥n</strong><br>
                    {{ resultado.valor_adquisicion }} ‚Ç¨
                </div>
                <div class="col-md-4">
                    <strong>Beneficio neto</strong><br>
                    {{ resultado.beneficio_neto }} ‚Ç¨
                </div>
                <div class="col-md-4">
                    <strong>ROI</strong><br>
                    {{ resultado.roi }} %
                </div>
                <div class="col-md-4 d-flex align-items-center">
                    {% if resultado.viable %}
                        <span class="badge bg-success fs-6 px-3 py-2">
                            ‚úî Operaci√≥n viable (ROI ‚â• 15%)
                        </span>
                    {% else %}
                        <span class="badge bg-danger fs-6 px-3 py-2">
                            ‚úñ Operaci√≥n no viable (ROI < 15%)
                        </span>
                    {% endif %}
                </div>
            </div>

            <hr class="my-3">

            <h6 class="text-muted mb-2">An√°lisis inversor</h6>

            <div class="row">
                <div class="col-md-4">
                    <strong>Margen neto</strong><br>
                    {{ resultado.margen_neto }} %
                </div>

                <div class="col-md-4">
                    <strong>Colch√≥n de seguridad</strong><br>
                    {{ resultado.colchon_seguridad }} %
                </div>

                <div class="col-md-4">
                    <strong>‚Ç¨ ganados por ‚Ç¨ invertido</strong><br>
                    {{ resultado.ratio_euro }} ‚Ç¨
                </div>

                <div class="col-md-4">
                    <strong>Precio m√≠nimo de venta</strong><br>
                    {{ resultado.precio_minimo_venta }} ‚Ç¨
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</form>
</div>


<script>
function formatEuro(value) {
    if (value === "" || value === null || isNaN(value)) return "";
    return new Intl.NumberFormat("es-ES", {
        style: "currency",
        currency: "EUR"
    }).format(value);
}


function parseEuro(value) {
    if (!value) return 0;
    return parseFloat(
        value
            .replace(/\./g, "")
            .replace(",", ".")
            .replace("‚Ç¨", "")
            .trim()
    ) || 0;
}

// --- FASE 1: Estado para detectar edici√≥n manual de precio de venta ---
let precioVentaManual = false;

function recalcMediaValoraciones() {
    const fields = [
        "val_idealista",
        "val_fotocasa",
        "val_registradores",
        "val_casafari",
        "val_tasacion"
    ];

    let total = 0;
    let count = 0;

    fields.forEach(name => {
        const el = document.querySelector(`[name="${name}"]`);
        if (el) {
            const v = parseEuro(el.value);
            if (v > 0) {
                total += v;
                count += 1;
            }
        }
    });

    const media = count > 0 ? total / count : 0;
    const target = document.querySelector('[name="media_valoraciones"]');
    if (target) {
        target.value = formatEuro(media);

        // Auto-suggest sale price from media (only if user hasn't edited it)
        const precioVenta = document.querySelector('[name="precio_venta_estimado"]');
        if (precioVenta && !precioVentaManual) {
            precioVenta.value = formatEuro(media);
        }
    }
}

function recalcPrecioCompraInmueble() {
    const escritura = parseEuro(document.querySelector('[name="precio_propiedad"]')?.value);

    // === C√ÅLCULOS AUTOM√ÅTICOS BASADOS EN PRECIO DE ESCRITURA ===
    const notariaCalc = Math.max(escritura * 0.002, 500);
    const registroCalc = Math.max(escritura * 0.002, 500);
    const itpCalc = escritura * 0.02;

    const notariaInput = document.querySelector('[name="notaria"]');
    const registroInput = document.querySelector('[name="registro"]');
    const itpInput = document.querySelector('[name="itp"]');

    if (notariaInput) notariaInput.value = formatEuro(notariaCalc);
    if (registroInput) registroInput.value = formatEuro(registroCalc);
    if (itpInput) itpInput.value = formatEuro(itpCalc);

    const gastos = [
        // Gastos de adquisici√≥n
        "notaria",
        "registro",
        "itp",
        "otros_gastos_compra",

        // Inversi√≥n inicial
        "reforma",
        "limpieza_inicial",
        "mobiliario",
        "otros_puesta_marcha",

        // Gastos recurrentes
        "comunidad",
        "ibi",
        "seguros",
        "suministros",
        "limpieza_periodica",
        "ocupas",

        // Gastos de venta (INCLUIDOS)
        "plusvalia",
        "inmobiliaria",
        "gestion_comercial",
        "gestion_administracion"
    ];

    let totalGastos = 0;
    gastos.forEach(name => {
        const el = document.querySelector(`[name="${name}"]`);
        if (el) totalGastos += parseEuro(el.value);
    });

    const total = escritura + totalGastos;
    const target = document.querySelector('[name="precio_compra_inmueble"]');
    if (target) {
        target.value = formatEuro(total);
        // target.dispatchEvent(new Event("blur")); // Removed forced blur (fix)
    }
}

document.querySelectorAll('input[data-euro="true"]').forEach(input => {
    input.addEventListener("blur", () => {

        // Skip formatting for valuation inputs to avoid clearing while typing
        if (input.hasAttribute("data-valuation")) {
            recalcPrecioCompraInmueble();
            recalcMediaValoraciones();
            return;
        }

        const raw = input.value;
        const val = parseEuro(raw);

        if (raw.trim() !== "" && val > 0) {
            input.value = formatEuro(val);
        } else {
            input.value = raw;
        }

        recalcPrecioCompraInmueble();
        recalcMediaValoraciones();
    });
});
// Recalculate totals when editing ‚ÄúPrecio de escritura‚Äù
const precioEscrituraInput = document.querySelector('[name="precio_propiedad"]');
if (precioEscrituraInput) {
    precioEscrituraInput.addEventListener("input", () => {
        recalcPrecioCompraInmueble();
    });
}

// --- FASE 1: Detectar edici√≥n manual del precio de venta estimado ---
const precioVentaInput = document.querySelector('[name="precio_venta_estimado"]');
if (precioVentaInput) {
    precioVentaInput.addEventListener("input", () => {
        precioVentaManual = true;
    });
}
function verCatastro() {
    const ref = document.querySelector('[name="ref_catastral"]')?.value?.trim();

    // Catastro siempre abre
    let url = "https://www.sedecatastro.gob.es/";

    // Si hay referencia, llevamos al buscador
    if (ref) {
        url = "https://www.sedecatastro.gob.es/Accesos/SECAccesos.aspx";
    }

    window.open(url, "_blank", "noopener");
}

const refInput = document.querySelector('[name="ref_catastral"]');
const btnCatastro = document.getElementById("btnCatastro");

if (refInput && btnCatastro) {
    const toggleCatastroButton = () => {
        if (refInput.value.trim() !== "") {
            btnCatastro.style.opacity = "1";
            btnCatastro.style.filter = "none";
        } else {
            btnCatastro.style.opacity = "1";
            btnCatastro.style.filter = "grayscale(40%)";
        }
    };

    refInput.addEventListener("input", toggleCatastroButton);
    toggleCatastroButton();
}
</script>

<script>
document.querySelector("form").addEventListener("submit", () => {
    document.querySelectorAll('input[data-valuation="true"]').forEach(input => {
        const val = parseEuro(input.value);
        if (val > 0) input.value = formatEuro(val);
    });
});
</script>

{% endblock %}

    <!-- ===============================
         PROYECTOS GUARDADOS
    ================================ -->
    <div class="card mb-4 shadow-sm border-0">
        <div class="card-body">
            <label class="form-label fw-semibold">Proyecto guardado</label>
            <select class="form-select form-select-lg"
                    onchange="
                        if (this.value !== '') {
                            window.location.href = '/?proyecto=' + encodeURIComponent(this.value);
                        } else {
                            document.querySelector('form').reset();
                            window.location.replace('/');
                        }
                    ">
                <option value="">‚Äî Nuevo proyecto ‚Äî</option>
                {% for p in proyectos %}
                    <option value="{{ p.nombre }}"
                        {% if proyecto and proyecto.nombre == p.nombre %}selected{% endif %}>
                        {{ p.nombre }}
                    </option>
                {% endfor %}
            </select>
        </div>
    </div>